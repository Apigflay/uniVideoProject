<template>
	<view class="main">
		<view class="top">
			<text>聊天</text>
		</view>
		<view class="center">
			<view  :style="no == false?'':'background:#343434'" class="new" @click="new_chat()" @touchstart="new_chat_start()" @touchend="new_chat_end()">
				<image class="img" src="../../static/pictures/newChat_1.png"></image>
				<text class="p">建立聊天室</text>
			</view>
			<view class="list" v-for="(item,index) in chatListData" :key="index" :id="index" @change="chat(index)">
				<image class="photo" :src="item.headpic" @click="goAchormePage(item.useridx)"></image>
				<view class="content" @click="goChatpopPage(item.useridx,item.nickname,item.headpic,item.online)">
					<view class="name">
						<view class="nameArea">
							<text class="id">{{item.nickname}}</text>
							<view class="status"></view>
						</view>
						<text class="data">
							{{item.lastTime}}
						</text>
					</view>
					<view class="p">
						<text>{{item.content}}</text>
					</view>
				</view>
			</view>
		</view>
		<!-- TagBar -->
		<view class="tabbarArea">
			<view class="per" v-for="(item,index) in tabbarData" :key="index" :id="index" @click="getClickPer">
				<image class="img" :src="item.imgsrcW" mode=""></image>
			</view>
		</view>
	</view>
</template>

<script>
	import {encrypt,decrypt,system,systemId,base64ToArrayBuffer,sendData,sendD,sendD06,sendD07,sendD09,sendD11,sendD13,sendD15,sendD17,work,regMail} from "../../lib/js/GlobalFunction.js"
	export default {
		data() {
			return {
				show_spot: true ,// 是否在线的值
				show_chat: false ,// 控制列表是否为点击状态
				no: false,
				table:[
					{id:0,data:'09/09', name:'@sasa.baby1235',content:'9月vip为两台飞机  享有8.9月百部影片，你的女神...', no:false},
					{id:1,data:'09/09', name:'@sasa.baby1236',content:'9月vip为两台飞机  享有8.9月百部影片，你的女神...', no:false},
					{id:2,data:'09/09', name:'@sasa.baby1237',content:'9月vip为两台飞机  享有8.9月百部影片，你的女神...', no:false},
				],
				page:1,//初始页数
				chatListData:null,//聊天列表
				// tabbar--
				tabbarLoginData:null,//loginMsg
				isAnchor:null,//是否为主播
				tabbarCurrent:0,//点击的索引
				tabbarData:[{imgsrcB:'../../static/imgs/room1w.png',imgsrcW:'../../static/imgs/fang1w.png',text:'1'},
					{imgsrcB:'../../static/imgs/fang1w.png',imgsrcW:'../../static/imgs/fang1w.png',text:'2'},
					{imgsrcB:'../../static/imgs/mail1w.png',imgsrcW:'../../static/imgs/mail1w.png',text:'3'},
					{imgsrcB:'../../static/imgs/xin1w.png',imgsrcW:'../../static/imgs/xin1y.png',text:'4'},
					{imgsrcB:'../../static/imgs/my1w.png',imgsrcW:'../../static/imgs/my1w.png',text:'5'}],//
			};
		},
		onLoad() {//监听页面加载，其参数为上个页面传递的数据，参数类型为Object
				this.getLoginMsg()//
				
		},
		methods:{
			getLoginMsg:function(){//登录信息
				var that = this;
				uni.getStorage({
					key: 'storage_login_str',
					success: function (res) {
						that.tabbarLoginData = JSON.parse(res.data);
						if(that.tabbarLoginData.isAnchor==false){
							that.isAnchor = false;
						}
						that.getChatList()//
					}
				});
			},
			getClickPer:function(e){//tabbar click
				this.tabbarCurrent=e.currentTarget.id;
				console.log(e.currentTarget.id)
				if(e.currentTarget.id==0){
					console.log("首页点击")
					uni.navigateTo({
						url: '/pages/home/home'
					});
				}else if(e.currentTarget.id==1){
					console.log("搜索点击")
					uni.navigateTo({
						url: '/pages/search/search'
					});
				}else if(e.currentTarget.id==2){
					console.log("信息点击")
					uni.navigateTo({
						url: '/pages/news/news'
					});
				}else if(e.currentTarget.id==3){
					console.log("聊天点击")
					uni.navigateTo({
						url: '/pages/chat/chat'
					});
				}else if(e.currentTarget.id==4){
					console.log(this.isAnchor)
					if(this.isAnchor==false){
						console.log("不是主播")
						uni.navigateTo({
							url: '/pages/my/my'
						});
					}else{
						console.log("是主播")
						uni.navigateTo({
							url: '/pages/anchorme/anchorme'
						});
					}
				}
			},
			chat:function(e){
				this.index = e;
				console.log(this.index)
			},
			chat_start:function(e){
				if(this.table[e].no == false){
					this.table[e].no = true;
				}else{
					console.log(this.table[e].no)
				}
			},
			chat_end:function(e){
				if(this.table[e].no == true){
					this.table[e].no = false;
				}else{
					console.log(this.table[e].no)
				}
			},
			new_chat_start:function(){
				// console.log(this.no)
				if(this.no == false){
					this.no = true;
				}else{
					console.log(this.no)
				}
			},
			new_chat_end:function(){
				// console.log(this.no)
				if(this.no == true){
					this.no = false;
				}else{
					console.log(this.no)
				}
			},
			// ----chat---
			getChatList:function(){//聊天列表信息获取
				// console.log(this.tabbarLoginData)
				// console.log(this.tabbarLoginData.useridx)
				// console.log(this.page)
				var array=base64ToArrayBuffer(encrypt(JSON.stringify({
					UserIdx:this.tabbarLoginData.useridx,//	int
					Page:this.page,//	int 页码
					Limit:20,//	int 页大小
				})))
				var res = JSON.parse(decrypt(sendData('POST',this.GLOBAL.urlPoint+'/userinfo/GetChatList',array)));
				if(res.code==100){
					var jRes=JSON.parse(JSON.stringify(res.data.list))
					jRes.forEach(function (value,index) {
						var month = new Date(value.lastTime).getMonth()+1;
						var day = new Date(value.lastTime).getDate();
						value.lastTime=month+'/'+day;
					});
					this.chatListData=jRes;
					console.log(jRes)
				}else{
					uni.showToast({
						title:res.msg,
						duration: 1500,
						icon:"none",
					});
				}
			},
			new_chat:function(){//新建聊天
				uni.navigateTo({
					url: '/pages/newchat/newchat'
				});
			},
			goAchormePage:function(msg){//跳转主播个人信息页面
				console.log(msg)
				uni.navigateTo({
					url: '/pages/anchorpersonal/anchorpersonal?AnchorIdx='+msg+'&Type=2'
				});
			},
			goChatpopPage:function(useridx,nickname,headpic,online){//跳转
				// console.log(useridx)
				// console.log(nickname)
				// console.log(headpic)
				uni.navigateTo({
					url: '/pages/chatpop/chatpop?useridx='+useridx+'&nickname='+nickname+'&headpic='+headpic+'&online='+online
				});
			}
		}
	}
</script>

<style lang="scss">
page{
	width: 100%;
	height: 100%;
	background: #191919;
}
.main{
	width: 100%;
	height: 100%;
	display: flex;
	align-items:center;
	flex-direction:column;
	.top{
		position:relative;
		width: 100%;
		height:100rpx;
		background: #252525;
		font-size: 30rpx;
		color:#FFFFFF;
		line-height: 100rpx;
		text-align: center;
	}
	.center{
		.new{
			display:flex;
			align-items: center;
			width:694rpx;
			height:129rpx;
			padding: 0rpx 28rpx;
			
			.img{
				width: 90rpx;
				height: 90rpx;
				margin-right: 40rpx;
			}
			.p{
				width:565rpx;
				border-bottom: 2rpx solid #343434;
				line-height: 129rpx;
				font-size:26rpx;
				color:#FFFFFF;
			}
		}
		.list{
			display:flex;
			align-items:center;
			padding: 0rpx 28rpx;
			width:694rpx;
			height:113rpx;
			.photo{
				background: #646464;
				height: 90rpx;
				width: 90rpx;
				border-radius: 50%;
				margin-right: 40rpx;
			}
			.content{
				display:flex;
				flex-direction: column;
				justify-content:center;
				align-items:center;
				height:113rpx;
				border-bottom: 2rpx solid #343434;
				.name{
					width: 565rpx;
					display:flex;
					align-items:center;
					justify-content: space-between;
					.nameArea{
						width: 300rpx;
						height: 62rpx;
						display:flex;
						align-items:center;
						// justify-content: space-between;
						.id{
							color:#FFFFFF;
							font-size:26rpx;
							line-height:26rpx;
							max-width: 275rpx;
							overflow: hidden;
							text-overflow:ellipsis;
							white-space: nowrap;
						}
						.status{
							margin-left: 11rpx;
							height: 12rpx;
							width: 12rpx;
							background: #00FF2A;
							border-radius: 50%;
						}
					}	
					.data{
						color: #ACACAC;
						font-size: 22rpx;
						line-height: 22rpx;
						float: right;
					}
				}
				.p{
					width:565rpx;
					color: #ACACAC;
					font-size: 22rpx;
					line-height: 22rpx;
					margin-top: 9rpx;
					overflow: hidden;
					text-overflow:ellipsis;
					white-space: nowrap;
				}
			}
		}
		
	}
		// --tabbar ---
	.tabbarArea{
		height: 90rpx;
		width: 100%;
		position: fixed;
		bottom: 0;
		left: 0;
		z-index: 9999;
		display: flex;
		justify-content: space-around;
		align-items: center;
		background:rgba(25,25,25,1);
		.per{
			width: 54rpx;
			height: 50rpx;
			.img{
				width: 54rpx;
				height: 50rpx;
			}
		}
	}
}

</style>
