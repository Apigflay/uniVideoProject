<template>
	<view class="main">
		<view class="top">
			<image class="img" src="../../static/pictures/back_1.png" @click="goback()"></image>
			{{this.Language.language[this.tabbarLoginLanguage].language215}}
		</view>
		<view class="chose" @click="getChose()">
			{{this.Language.language[this.tabbarLoginLanguage].language157}}
			<image v-if="chose" class="img" src="../../static/pictures/sanjiao1_1.png"></image>
			<image v-else class="img" src="../../static/pictures/sanjiao2_1.png"></image>
		</view>
		<view class="pop">
			<view v-if="chose" class="popup" v-for="(item,index) in tables[tabbarLoginLanguage]" :key="index" :id="index">
				<view class="box" @click="getMsg(index)">{{item.name}}</view>
			</view>
		</view>
		<scroll-view :scroll-y="true" @scrolltolower="getNewMsg" :scroll-top="scrtop" class="center"  ref='testDom'>
			<view class="list" v-for="(item,index) in model1Data" :key="index" :id="index">
				<view class="time">{{item.lastfirstDay}}</view>
				<view class="content">
					<view class="div">
						<text class="p1" v-if="item.Type==1 && tabbarLoginLanguage == 0">获得金币</text>
						<text class="p1" v-if="item.Type==1 && tabbarLoginLanguage == 1">獲得金幣</text>
						<text class="p1" v-if="item.Type==1 && tabbarLoginLanguage == 2">Get coins</text>
						<text class="p1" v-if="item.Type==1 && tabbarLoginLanguage == 3">ได้รับเหรียญ</text>
						
						<text class="p1" v-if="item.Type==2 && tabbarLoginLanguage == 0">使用金币</text>
						<text class="p1" v-if="item.Type==2 && tabbarLoginLanguage == 1">使用金幣</text>
						<text class="p1" v-if="item.Type==2 && tabbarLoginLanguage == 2">Use coins</text>
						<text class="p1" v-if="item.Type==2 && tabbarLoginLanguage == 3">การบริโภค</text>
						
						<text class="p1" v-if="item.Type==3 && tabbarLoginLanguage == 0">购买金币</text>
						<text class="p1" v-if="item.Type==3 && tabbarLoginLanguage == 1">購買金幣</text>
						<text class="p1" v-if="item.Type==3 && tabbarLoginLanguage == 2">buy coins</text>
						<text class="p1" v-if="item.Type==3 && tabbarLoginLanguage == 3">ซื้อเหรียญ</text>
						<text class="p2">{{item.lastfirstTime}}</text>
					</view>
					<view class="div1"><image class="img" src="../../static/imgs/goldM1.png"></image><text class="p1">{{item.Coin}}</text></view>
					<text class="p">{{item.Descript}}</text>
				</view>
			</view>
		</scroll-view>
	</view>
</template>

<script>
	import {encrypt,decrypt,system,systemId,base64ToArrayBuffer,sendData,sendD,work,sendD07,navigateTo} from "../../lib/js/GlobalFunction.js"
	export default {
		data() {
			return {
				tabbarLoginLanguage: null, // 用户语言
				chose: false, // 选项按钮的绑定数据
				tabbarLoginData: null, // 用户个人数据
				UserIdx: null, // 用户IDX
				Page: 1, // 传参页数
				Type: 0, // 传参类型
				model1Data: null, // 用户消费明细数据
				model2Data: null, // 用户数据表下拉加载数据
				tables:[[
					{name:'所有'},
					{name:'获得'},
					{name:'使用'},
					{name:'购买'}],
					
					[{name:'所有'},
					{name:'獲得'},
					{name:'使用'},
					{name:'購買'}],
					
					[{name:'All'},
					{name:'Get'},
					{name:'Use'},
					{name:'Buy'}],
					
					[{name:'ทั้งหมด'},
					{name:'ได้รับเหรียญ'},
					{name:'การบริโภค'},
					{name:'ซื้อเหรียญ'}],
				],
				scrtop: 1, //页面点击选项按钮向下滚动初始值
			};
		},
		onLoad(){
			this.getLoginlanger(); // 获取语言
			this.getLoginMsg();
			this.getInitMsg();
			
		},
		methods:{
			getLoginlanger:function(){ // 获取当前语言
				var that = this;
				uni.getStorage({
					key: 'storage_login_language',
					success: function (res) {
						that.tabbarLoginLanguage = JSON.parse(res.data);
						// console.log(that.tabbarLoginLanguage);
						
					}
				});
			},
			// --------------------------页面初始加载用户数据-----------------------------------------
			getLoginMsg:function(){//登录信息
				var that = this;
				uni.getStorage({
					key: 'storage_login_str',
					success: function (res) {
						that.tabbarLoginData = JSON.parse(res.data);
						// console.log(that.tabbarLoginData.useridx);
						that.loginMsgData = that.tabbarLoginData
						that.UserIdx = that.tabbarLoginData.useridx;
						if(that.tabbarLoginData.isAnchor==false){
							that.isAnchor = false;
						}
					}
				});
			},
			// --------------------------页面初始加载用户数据-----------------------------------------
			
			//----------------------------页面首次加载的数据------------------------------------------
			getInitMsg:function(e){ //页面初始化加载的数据
				var array=base64ToArrayBuffer(encrypt(JSON.stringify({
					userIdx: this.UserIdx, // int
					Page: this.Page,// int
					Type: this.Type // int
				})))
				var res = JSON.parse(decrypt(sendData('POST',this.GLOBAL.urlPoint+'/UserInfo/GetUserConsdetail',array)));
				if(res.code==100){
					// console.log(res);
					this.model1Data=res.data.list;
					// console.log(this.model1Data)
					this.getDate();
				}
			},
			//----------------------------页面首次加载的数据------------------------------------------
			
			// -------------------------变换搜索条件------------------------------------------------
			getChose:function(){ 
				if(this.chose == false){
					this.chose = true;
					this.scrtop = this.scrtop + 1;
				}else if(this.chose == true){
					this.chose = false;
				}
				
				
			  // document.documentElement.scrollTop 
			  // this.$refs.testDom.scrollBy(0, 100)
			  // this.scrollheight = this.$refs.testDom.scrollTop
			  // console.log(this.scrollheight)
				   
			},
			
			getMsg:function(e){ // 
				// console.log(e);
				this.Type = e;
				this.Page = 1;
				var array=base64ToArrayBuffer(encrypt(JSON.stringify({
					userIdx: this.UserIdx, // int
					Page: this.Page,// int
					Type: this.Type // int
				})))
				var res = JSON.parse(decrypt(sendData('POST',this.GLOBAL.urlPoint+'/UserInfo/GetUserConsdetail',array)));
				if(res.code==100){
					// console.log(res);
					this.model1Data=res.data.list;
					// console.log(this.model1Data)
					this.getDate();
				}
				// console.log(this.chose);
				// this.chose = false;
			},
			// -------------------------变换搜索条件------------------------------------------------
			
			//----------------------------下拉加载---------------------------------------------------
			getNewMsg:function(){
				this.Page++;
				
				var array=base64ToArrayBuffer(encrypt(JSON.stringify({
					userIdx: this.UserIdx, // int
					Page: this.Page,// int
					Type: this.Type // int
				})))
				var res = JSON.parse(decrypt(sendData('POST',this.GLOBAL.urlPoint+'/UserInfo/GetUserConsdetail',array)));
				if(res.code==100){
					// console.log(res);
					this.model2Data=res.data.list;
					this.model1Data.push.apply(this.model1Data,this.model2Data);
					console.log(this.model1Data)
					this.getDate();
				}
			},
			//----------------------------下拉加载---------------------------------------------------
			
			//-----------------------------获取时间----------------------------------------------------
			getDate:function(){ // 
				this.chose = false; // 关闭弹出层
				for(var i = 0; i<=this.model1Data.length; i++){
					// var b = this.model1Data[i].TradeDate.replace(/T/g, ' ').replace(/\.[\d]{3}Z/, ''); // 去除获取到的后台时间数去中的 T
					var date = Date.parse(this.model1Data[i].TradeDate);  // 时间戳 TradeDate
					var time = new Date(date);
					// console.log(time) // 时间戳转换日期格式
					
					var lastfirst_year = time.getFullYear();
					var lastfirst_month = time.getMonth()+1<10?'0'+(time.getMonth()+1):time.getMonth()+1;
					var lastfirst_date = time.getDate()<10?'0'+time.getDate():time.getDate();
					var lastfirst_hour = time.getHours()<10?'0'+time.getHours():time.getHours();
					var lastfirst_minut = time.getMinutes()<10?'0'+time.getMinutes():time.getMinutes();
					var lastfirstDay=lastfirst_year+'.'+lastfirst_month+'.'+lastfirst_date;//上周一的年月日
					var lastfirstTime = lastfirst_hour+ ':' + lastfirst_minut;
					
					this.model1Data[i].lastfirstDay = lastfirstDay;
					this.model1Data[i].lastfirstTime = lastfirstTime;
					// console.log(this.model1Data);
					
				}
			},
			//-----------------------------获取时间----------------------------------------------------
			
			//-----------------------------回退---------------------------------------------------------
			goback:function(){
				// uni.navigateTo({
				// 	url: "/pages/dataset/dataset"
				// })
				navigateTo('/pages/dataset/dataset',null);
			},
			//-----------------------------回退---------------------------------------------------------
		}
	}
</script>

<style lang="scss">
page{
	width:100%;
	height: 100%;
	background: #191919;
}
.main{
	width:100%;
	height: 100%;
	display:flex;
	flex-direction: column;
	.top{
		padding: 32rpx 0rpx;
		background-color:#252525;
		text-align: center;
		font-size: 30rpx;
		color:#FFFFFF;
		.img{
			position: absolute;
			left: 10rpx;
			width: 36rpx;
			height: 36rpx;
			padding: 10rpx;
		}
	}
	.chose{
		position: relative;
		width: 100%;
		padding: 32rpx 0rpx;
		background-color:#252525;
		text-align: center;
		font-size: 30rpx;
		color:#FFFFFF;
		border-top: 1rpx solid #747474;
		border-bottom: 1rpx solid #747474;
		.img{
			position: absolute;
			top: 50rpx;
			width: 20rpx;
			height: 10rpx;
			padding-left: 25rpx;
		}
	}
	.pop{
		width: 100%;
		position: absolute;
		top:205rpx;
		z-index: 9999;
		background:#191919;
		.popup{
			width:100%;
			// background: #4CD964;
			.box{
				line-height: 100rpx;
				font-size: 30rpx;
				text-align: center;
				color:#FFFFFF;
				border-top: 1rpx solid #747474;
				border-bottom: 1rpx solid #747474;
			}
		}
	}
	
	.center{
		flex:1;
		overflow-y:scroll;
		.list{
			width: 100%;
			.time{
				font-size:22rpx;
				color: #747474;
				padding:60rpx 0rpx 23rpx 36rpx;
			}
			.content{
				position: relative;
				z-index: 0;
				padding: 23rpx 37rpx;
				border-top: 1rpx solid #747474;
				border-bottom: 1rpx solid #747474;
				background: #252525;
				.div{
					display:flex;
					justify-content:space-between;
					.p1{
						font-size: 26rpx;
						color: #FFFFFF;
					}
					.p2{
						font-size: 22rpx;
						color: #747474;
					}
				}
				.p{
					font-size: 22rpx;
					line-height: 22rpx;
					padding-top: 15rpx;
					color: #747474;
					max-width: 700rpx;
					display: -webkit-box;
					-webkit-box-orient: vertical;
					-webkit-line-clamp: 3;//几行省略就写几
					overflow: hidden;
				}
				.div1{
					.img{
						width: 24rpx;
						height: 22rpx;
						padding-right: 15rpx;
					}
					.p1{
						font-size: 22rpx;
						color: #747474;
					}
				}
				
			}
		}
	}
}
</style>
