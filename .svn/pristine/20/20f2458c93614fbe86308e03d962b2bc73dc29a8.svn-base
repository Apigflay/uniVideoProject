<template>
	<view class="main">
		<view class="content">
			<!-- 页面上部标题 -->
			<view class="top"> 
				<view class="left" @click="goBack()">
					<image class="img" src="../../static/pictures/back_1.png"></image>
				</view>
				<view class="center1">
					<view class="title">
						<view class="spot" v-if="chatObjOnline==1"></view>
						<text class="p">{{chatObjNickname}}</text>
					</view>
				</view>
				<view class="right" @click="goPay()">
					<view class="box">
						<image class="img" src="../../static/pictures/zuanshi_1.png"></image>
						<text class="p">{{tabbarLoginData.cash}}</text>
					</view>
				</view>
			</view>
			<!-- 页面中部聊天内容 --> 
			<view class="center" @click="close()" id="center">
				<view class="chat" id="chat">
					<!-- 第一次聊天tips -->
					<view class="span_hi" v-if="showhi">
						<text class="p">{{this.Language.language[this.tabbarLoginLanguage].language212}}</text>
						<text class="p">{{this.Language.language[this.tabbarLoginLanguage].language213}}</text>
					</view>
					<!-- 日期 -->
					<!-- <view class="span_date" v-if="showdate">
						<text class="p">{{date}}</text>
					</view> -->
					<view class="span_chat">
						<view :class="item.direction == 0?'right':'left'"  v-for="(item,index) in chatNewMsgData.msgs" :key="index" :id="index">
							<image class="img" :src="item.photo"></image>
							
							<view class="div" :class="item.type==6?'div6':''" @click="goWatch(item)">
								<!-- 1:文本 2.图片 3.视频 5.礼物 6.作品 -->
								<image :style="'width:240rpx;height:'+240/item.content.width*item.content.height+'rpx'" class="pngPhoto" :src="item.content.url" v-if="item.type==2"></image>
								<image class="png" :src="item.giftPhoto" v-if="item.type==5"></image>
								<text class="p" v-if="item.type==1">{{item.content}}</text>
								
								<image class="img6"  :src="item.content.BackgroundPicUrl" v-if="item.type==6"></image>
								<text class="p6"  v-if="item.type==6">{{item.content.Content}}似懂非懂是发送到发送到发dfsdfs防守打法水电费水电费水电费水电费所发生的防守打法送到是的水电费水电费水电费水电费水电费是发</text>
								
								<video style="width:400rpx;height:325rpx" :src="item.content.url" :controls="true" objectFit="fill" show-fullscreen-btn="true" :show-center-play-btn="true"  v-if="item.type==3"></video>
							</view>
							<text class="p2">{{item.nowTime}}</text>
						</view>
					</view>
				</view>
			</view>
			<!-- 页面下部礼物 输入部分 -->
			<view class="bottom">
				<image class="img" src="../../static/pictures/liwu_1.png" @click="liwu()"></image>
				<view class="p"></view>
				<image class="img1" src="../../static/pictures/xiangji_1.png" @click="xiangji()"></image>
				<view class="span" @click="chat()">
					<text class="p1">以</text><image class="img2" src="../../static/pictures/zuanshi_1.png"></image><text class="p1">{{money}}传送信息</text>
				</view>
				<image class="send" src="../../static/imgs/send1y.png" mode="" @click="sendChatMsg"></image>
				<input class="input" :style="inputBg" @blur="changeInputW" @focus="changeInputBg" v-model="inputMsg" type="text" value="" />
			</view>
			<view class="gift" v-show="show_gift">
				<!-- swiper 滑动 -->
				<view class="swiperArea">
					<swiper class="swiper" :current="current" :circular="circular" :indicator-dots="indicatorDots" :autoplay="autoplay" :interval="interval" :duration="duration" @animationfinish="getChangeMsg">
						<swiper-item v-for="(item,index) in GiftsData" :key="index" :id="index">
							<view class="swiper-item uni-bg-green">
								<view class="listPer" v-for="(item1,index1) in item.list" :key="index1" :id="index1" @click="sendPic(item1.giftId)">
									<view class="gift_img"><image class="photo" :src="item1.icon"></image></view>
									<view class="gift_name">{{item1.name}}</view>
									<view class="gift_num"><image class="img" src="../../static/pictures/zuanshi_1.png"></image><text class="text">{{item1.price}}</text></view>
								</view>
								
							</view>
						</swiper-item>
						
					</swiper>		
				</view>
				<!-- tab 组件 -->
				<view class="tab">
					<view :class="index==current?'tabActive':'item'" v-for="(item,index) in GiftsData" :key="index" :id="index" @click="changeTab(index)">
						<text class="text">{{item.tabName}}</text>
					</view>
				</view>
			</view>
		</view>
	</view>
</template>

<script>
	import {encrypt,decrypt,system,systemId,productType,base64ToArrayBuffer,sendData,sendD,sendD06,sendD07,sendD09,sendD11,sendD13,sendD15,sendD17,sendD201,sendD217,sendD204,work,regMail,navigateTo} from "../../lib/js/GlobalFunction.js"
	export default {
		data() {
			return {
				tabbarLoginLanguage: null, // 用户语言
				name: '@sasa.baby1235', // 用户ID
				num: 30, // 剩余钻石数
				money:800, // 通话价格
				show_gift: false,  // 页面礼物部分开关
				showhi: true, // 新建聊天系统自带文字
				showdate: true, // 是否显示上次聊天时间
				style:"",//顶部固定导航
				indicatorDots: false,//指示点显示
				autoplay: false,//自动播放
				interval: 2000,//间隔
				duration: 500,//动画时长
				circular:true,//衔接
				current:0,//当前activity的滑块
				date: '08/26',
				tabData:[ // tab 标题
					{id: 0,text:'应援'},
					{id: 1,text:'情趣用品'},
					{id: 2,text:'角色扮演'},
					{id: 3,text:'生日快乐'},
					{id: 4,text:'漂亮宝贝'},
					{id: 5,text:'奢华宝贝'}
				],
				chats:[
					{
						self: 0,
						imgsrc: "../../static/pictures/search_1.png",
						text: '想看看视频9月vip为两台飞机 享有8.9月百部影片，你的女... ',
						time: '15:18'
					},
					{
						self: 1,
						imgsrc: "../../static/pictures/search_1.png",
						text: '想看看视频9月vip为两台飞机 享有8.9月百部影片，你的女... ',
						time: '15:18'
					},
					{
						self: 1,
						imgsrc: "../../static/pictures/search_1.png",
						text: '想看看视频9月vip为两台飞机 享有8.9月百部影片，你的女... ',
						time: '15:18'
					},
					{
						self: 1,
						imgsrc: "../../static/pictures/search_1.png",
						text: '想看看视频9月vip为两台飞机 享有8.9月百部影片，你的女... ',
						time: '15:18'
					},
					{
						self: 1,
						imgsrc: "../../static/pictures/search_1.png",
						text: '想看看视频9月vip为两台飞机 享有8.9月百部影片，你的女... ',
						time: '15:18'
					},
					{
						self: 1,
						imgsrc: "../../static/pictures/search_1.png",
						text: '想看看视频9月vip为两台飞机 享有8.9月百部影片，你的女... ',
						time: '15:18'
					},
					{
						self: 0,
						imgsrc: "../../static/pictures/search_1.png",
						text: '想看看视频9月vip为两台飞机 享有8.9月百部影片，你的女... ',
						time: '15:18'
					},
					{
						self: 0,
						imgsrc: "../../static/pictures/search_1.png",
						text: '想看看视频9月vip为两台飞机 享有8.9月百部影片，你的女... ',
						time: '15:18'
					},
					{
						self: 0,
						imgsrc: "../../static/pictures/search_1.png",
						text: '想看看视频9月vip为两台飞机 享有8.9月百部影片，你的女... ',
						pngsrc: "../../static/pictures/bgtop.jpg",
						time: '15:18',
						pngshow: true
					},
					{
						self: 1,
						imgsrc: "../../static/pictures/search_1.png",
						pngsrc: "../../static/pictures/bgtop.jpg",
						text: '想看看视频',
						time: '15:18',
						pngshow: true
					},
				],
				scrollheight: null,
				// 聊天信息----
				tabbarLoginData:null,//login msg
				chatObjUseridx:'',//当前聊天对象idx
				chatObjNickname:'',//当前聊天对象名称
				chatObjHeadpic:'',//当前聊天对象头像
				chatObjOnline:'',//当前聊天对象是否在线
				chatObjpageId:'',// --------接收页面回退时使用的pageid-----------
				chatObjpagebackId: '', // 聊天页面回退时代的上一个页面回退时需要的ID
				GiftsData:null,//礼物信息  已完成分类
				inputBg:'',//聊天输入框背景
				inputMsg:'',//聊天输入框信息
				NoGiftsData:null,//礼物信息  未完成分类
				chatNewMsgData:null,//最新聊天信息
			};
		},
		onLoad(obj) {
			var option=JSON.parse(decrypt(decodeURIComponent(obj.action)));
			console.log(option)
			this.chatObjUseridx=option.useridx;
			this.chatObjNickname=option.nickname;
			this.chatObjHeadpic=option.headpic;
			this.chatObjOnline=option.online;
			this.chatObjpageId=option.pageId; // 页面回退时使用的pageid
			this.chatObjpagebackId=option.pagebackId; // 回退后传递的下一个回退ID
			this.getLoginlanger(); // 获取语言
			this.getLoginMsg()
			this.getGiftsMsg()//礼物列表
			this.getMsgPrice()//主播私讯价格
			
			
		},
		onShow(){
			// 
			this.getChatMsgData()//拉取用户信息
		},
		 // onPullDownRefresh() {//下拉刷新
		 // console.log(document.getElementById("center").clientHeight)
		 // console.log(document.getElementById("chat").clientHeight)
		 // console.log(document.getElementById("chat").scrollTop)
		 // console.log(document.getElementById("center").scrollTop)
			// console.log('下拉刷新');
			// alert('下拉刷新')
			// 	setTimeout(function () {
			// 	uni.stopPullDownRefresh();
			// }, 1000);
		
		// },
		onPageScroll(www){
			// console.log(www)
			if(document.documentElement.scrollTop>=100){
				this.style="background: rgba(0,0,0,0.3);"
			}else{
				this.style=""
			}
		},
		methods:{
			getLoginlanger:function(){ // 获取当前语言
				var that = this;
				uni.getStorage({
					key: 'storage_login_language',
					success: function (res) {
						that.tabbarLoginLanguage = JSON.parse(res.data);
						console.log(that.tabbarLoginLanguage);
						if(that.tabbarLoginLanguage == 0){
							that.langer = 0;
						}else if(that.tabbarLoginLanguage == 1){
							that.langer = 1;
						}else if(that.tabbarLoginLanguage == 2){
							that.langer = 2;
						}else if(that.tabbarLoginLanguage == 3){
							that.langer =3;
						}
					}
				});
			},
			getLoginMsg:function(){//登录信息
				var that = this;
				uni.getStorage({
					key: 'storage_login_str',
					success: function (res) {
						// console.log(JSON.parse(res.data))
						that.tabbarLoginData = JSON.parse(res.data);
					}
				});
			},
			liwu:function(){ // 礼物页面
				// console.log("aaa");
				if(this.show_gift == false){
					this.show_gift = true
				}else{
					this.show_gift = false
				}
			},
			close:function() { // 点击页面body部分 关闭礼物页面
				this.show_gift = false;
			},
			changeTab:function(e){ // tab 部分
				this.current = e;
				// console.log(this.current);
			},
			getChangeMsg:function(e){ // swiper 给 tab传值
				this.current = e.detail.current
			},
			goBack:function(){ // 页面退回上一页
				if(this.chatObjpageId == 11){
					var obj = encodeURIComponent(encrypt(JSON.stringify({
						pageId:this.chatObjpagebackId
					})))
					navigateTo('/pages/followpopup/followpopup',obj);
				}else if(this.chatObjpageId == 12){
					// uni.navigateTo({
					// 	url: '/pages/fanspopup/fanspopup'
					// })
					navigateTo('/pages/fanspopup/fanspopup',null);
				}else if(this.chatObjpageId == 4){
					uni.navigateBack({
					    delta: 1
					});
				}else if(this.chatObjpageId == 14){
					console.log('aaa')
					// uni.navigateTo({
					// 	url: '/pages/chat/chat'
					// })
					navigateTo('/pages/newchat/newchat',null);
				}else if(this.chatObjpageId == 13){
					navigateTo('/pages/chat/chat',null);
				}else if(this.chatObjpageId == 8){
					uni.navigateBack({
					    delta: 1
					});
				}else if(this.chatObjpageId == 7){
					var obj = encodeURIComponent(encrypt(JSON.stringify({
						pageId:this.chatObjpagebackId, //回退的页面需要的回退ＩＤ
						AnchorName:this.chatObjNickname, // 主播昵称
						AnchorIdx:this.chatObjUseridx, // 主播IDX
					})))
					navigateTo('/pages/unlockvideo/unlockvideo',obj);
				}
				// uni.navigateBack({
				//     delta: 1
				// });
			},
			getGiftsMsg:function(){//礼物列表  拉取聊天信息
				uni.request({
					url: this.GLOBAL.urlPoint+'/living/GetGiftList' ,//仅为示例，并非真实接口地址。
					method:"GET",
					data: {
					},
					success: (res) => {
						if(JSON.parse(decrypt(res.data)).code==100){
							
							var jRes =JSON.parse(decrypt(res.data)).data;
							jRes.tabList.forEach(function (value,index) {
								value.list=[]
							});
							jRes.tabList.forEach(function (value1,index1) {
								jRes.giftList.forEach(function (value2,index2) {
										if(value1.tabid==value2.tabid){
											value1.list.push(value2)
										}
								});
									
							});
							this.GiftsData=jRes.tabList;
							this.NoGiftsData=JSON.parse(decrypt(res.data)).data.giftList;
							// console.log(JSON.parse(decrypt(res.data)).data.giftList)
							// console.log(jRes.tabList)
							this.getChatMsgData()//拉取用户信息
							
						}
					}
				});
			},
			changeInputBg:function(){//输入框聚焦
				this.inputBg='background:#252525;'
			},
			changeInputW:function(event){//输入框失去焦点 若为空则透明
				// this.inputBg=''
				// console.log(event.target.value) 
				if(event.target.value==''){
					this.inputBg=''
				}
			},
			sendChatMsg:function(){//发送按钮发送消息
				// console.log("发送消息 ")
				// console.log(this.inputMsg)
				// alert(this.inputMsg)
				var kongInputMsg =this.inputMsg.replace(/^\s*/,"");
				// console.log(this.tabbarLoginData)
				// console.log(this.chatObjUseridx)
				if(kongInputMsg==""){
					uni.showToast({
						title: '不能发送空白信息',
						duration: 1500,
						icon:"none",
						success: function () {
						}
					});
				}else{
					// --
					var nowTime = new Date().getTime();
					// console.log(nowTime)
					var nickname=this.tabbarLoginData.nickname;
					var headpic=this.tabbarLoginData.headpic;
					var that =this;
					// -------------
					var array =JSON.stringify({
						"appId": 100,            //   int   APP ID
						"useridx": this.tabbarLoginData.useridx,   //   int   发送者
						"toUseridx": Number(this.chatObjUseridx),   //   int    消息接受者
						"type": 1,                //  int    消息类型(1:文本 2.图片 3.视频 5.礼物)
						"content": this.inputMsg, //string  
						"msgToken": JSON.stringify(nowTime),// string  
						"retry":false,//  是否重发状态
						"attach":{name:nickname,head:headpic},
						"devId":systemId(),
						"devType":system(),
						"productType":productType(),
					})
					// console.log(JSON.parse(array))
					
					var arr = sendD201(array);
					// --------socket-login---------------
					// console.log(this.$Socket.isconnect)
					// console.log(this.$Socket)
					if(this.$Socket.isconnect==false){
						this.$Socket.onReload()
					}
					this.$Socket.nsend(arr)
					this.$Socket.eventPatch.onMsg((msg,sk)=>{    //监听是否接受消息
						// console.log(msg)
						// console.log(sk)
						 var fileReader = new FileReader();
						     fileReader.onload = function (progressEvent) {
						     	var arrayBuffer = this.result; // arrayBuffer即为blob对应的arrayBuffer
						     	var HeadRecv = new Uint32Array(arrayBuffer, 0, 3);
						     	var strArray = new Uint8Array(arrayBuffer, 12, HeadRecv[0] - 12 - 1);
						     	var str = new TextDecoder().decode(strArray);//{"code":-1,"error":"用户名或密码错误"}
						     	// console.log(HeadRecv[1],JSON.parse(str))
						     	//to do
								// console.log(HeadRecv[1])
								// console.log(JSON.parse(str))
								// alert(HeadRecv[1])
								// alert(str)
								var msgdata =JSON.parse(str);
								if(HeadRecv[1]==20002){
									if(msgdata.code==0){
										that.inputBg='';
										that.inputMsg='';
										that.getChatMsgData()//拉取消息
									}
									// that.money=msgdata.price;
									// uni.setStorage({
									// 	key: 'storage_login_str',
									// 	data: str,
									// 	success: function () {
									// 		console.log('success');
									// 	}
									// });
								}else if(HeadRecv[1]==10010){
									uni.showToast({
										title: '登录信息过期，请重新登录',
										duration: 1500,
										icon:"none",
										success: function () {
												// uni.navigateTo({
												// 	url: '/pages/startup/startup'
												// });
												navigateTo('/pages/startup/startup',null);
										}
									});
									
								}
						     	
						     };
						     fileReader.readAsArrayBuffer(msg.data);
					})
					// ----------------
				}
			},
			sendPic:function(giftId){//礼物图片点击
				// console.log(giftId)
				var that =this;
				// -----------
				var nowTime = new Date().getTime();
				var nickname=that.tabbarLoginData.nickname;
				var headpic=that.tabbarLoginData.headpic;
				var imgObj =JSON.stringify({giftId:giftId,
							num:1,
							})
				// console.log(imgObj)
				// console.log(JSON.parse(imgObj))
				// -------------
				var array =JSON.stringify({
					"appId": 100,            //   int   APP ID
					"useridx": that.tabbarLoginData.useridx,   //   int   发送者
					"toUseridx": Number(that.chatObjUseridx),   //   int    消息接受者
					"type": 5,                //  int    消息类型(1:文本 2.图片 3.视频 5.礼物)
					"content": imgObj, //string  
					"msgToken": JSON.stringify(nowTime),// string  
					"retry":false,//  是否重发状态
					"attach":{name:nickname,head:headpic,giftId:giftId,num:1},
					"devId":systemId(),
					"devType":system(),
					"productType":productType(),
				})
				// console.log(JSON.parse(array))
				
				var arr = sendD201(array);
				// --------socket-login---------------
				// console.log(that.$Socket.isconnect)
				// console.log(this.$Socket)
				if(that.$Socket.isconnect==false){
					that.$Socket.onReload()
				}
				that.$Socket.nsend(arr)
				that.$Socket.eventPatch.onMsg((msg,sk)=>{    //监听是否接受消息
					// console.log(msg)/
					// console.log(sk)
					 var fileReader = new FileReader();
					     fileReader.onload = function (progressEvent) {
					     	var arrayBuffer = this.result; // arrayBuffer即为blob对应的arrayBuffer
					     	var HeadRecv = new Uint32Array(arrayBuffer, 0, 3);
					     	var strArray = new Uint8Array(arrayBuffer, 12, HeadRecv[0] - 12 - 1);
					     	var str = new TextDecoder().decode(strArray);//{"code":-1,"error":"用户名或密码错误"}
					     	// console.log(HeadRecv[1],JSON.parse(str))
					     	//to do
							// console.log(HeadRecv[1])
							// console.log(JSON.parse(str))
							var msgdata =JSON.parse(str);
							if(HeadRecv[1]==20002){
								if(msgdata.code==0){
									that.inputBg='';
									that.inputMsg='';
									that.getChatMsgData()//拉取消息
								}
								// that.money=msgdata.price;
								// uni.setStorage({
								// 	key: 'storage_login_str',
								// 	data: str,
								// 	success: function () {
								// 		console.log('success');
								// 	}
								// });
							}else if(HeadRecv[1]==10010){
								uni.showToast({
									title: '登录信息过期，请重新登录',
									duration: 1500,
									icon:"none",
									success: function () {
											// uni.navigateTo({
											// 	url: '/pages/startup/startup'
											// });
											navigateTo('/pages/startup/startup',null);
									}
								});
								
							}
					     	
					     };
					     fileReader.readAsArrayBuffer(msg.data);
				})
				// ----------------
				
				// ---------
			},
			xiangji:function(){ // 相机
				// console.log("开始选择图片");
				// ----------------
				var that =this;
				// console.log(that.GLOBAL.urlPoint)
				uni.chooseImage({
					count:1,//图片数量
					sizeType:['compressed '],//压缩图
					sourceType:['album','camera'],//相册 相机
					success: function (res) {
						// console.log(res.tempFilePaths[0])
						uni.getImageInfo({
							src: res.tempFilePaths[0],
							success: function (image) {
								// console.log(image.width);
								// console.log(image.height);
								//to  do--------
								uni.request({
									url: res.tempFilePaths[0],
									method:'GET',
									responseType: 'arraybuffer',
									success: ress => {
										// console.log(ress.data)//流
										let base64 = wx.arrayBufferToBase64(ress.data); //把arraybuffer转成base64 
										base64 = 'data:image/jpeg;base64,' + base64 //不加上这串字符，在页面无法显示的哦
										// console.log(base64)
										// ------------------2222-----
										// 将base64转换为文件对象
										function dataURLtoFile(dataurl, filename) {
										  var arr = dataurl.split(',');
										  var mime = arr[0].match(/:(.*?);/)[1];
										  var bstr = atob(arr[1]);
										  var n = bstr.length; 
										  var u8arr = new Uint8Array(n);
										  while(n--){
											  u8arr[n] = bstr.charCodeAt(n);
										  }
										  // 转换成file对象
										  return new File([u8arr], filename, {type:mime});//FormData File
										  // 转换成成blob对象
										  // return new Blob([u8arr],{type:mime});
										}
										// 将图片转换为base64,再将base64转换成file对象
										var file=dataURLtoFile(base64,'imgHeader')
										// console.log(file)
										// console.log(image.width);
										// console.log(image.height);
										// --------------2222
										var formData = new FormData();
										formData.append('picture',file);
										formData.append('userIdx',that.tabbarLoginData.useridx);//that.tabbarLoginData.useridx
										formData.append('token',that.tabbarLoginData.webtoken);//that.tabbarLoginData.webtoken
										formData.append('type',0);
										formData.append('width',image.width);
										formData.append('Height',image.height);
												
										var xhr = new XMLHttpRequest;
										xhr.open('POST',that.GLOBAL.urlPoint+'/userinfo/newsUploadResource', false);
										xhr.send(formData);
										// console.log(xhr.responseText)
										// console.log(decrypt(xhr.responseText))
										var resObj=JSON.parse(decrypt(xhr.responseText))
										// console.log(resObj)
										if(resObj.code==100){
											uni.showToast({
												title: resObj.msg,
												duration: 1500,
												icon:"none",
												success:function(res){
													
												}
											});
											// console.log(resObj.data.orgin)
											var nowTime = new Date().getTime();
											var nickname=that.tabbarLoginData.nickname;
											var headpic=that.tabbarLoginData.headpic;
											var imgObj =JSON.stringify({fileName:resObj.data.orgin.url,
														url:resObj.data.orgin.url,
														height:resObj.data.orgin.height,
														width:resObj.data.orgin.width,
														})
											// console.log(imgObj)
											// console.log(JSON.parse(imgObj))
											// -------------
											var array =JSON.stringify({
												"appId": 100,            //   int   APP ID
												"useridx": that.tabbarLoginData.useridx,   //   int   发送者
												"toUseridx": Number(that.chatObjUseridx),   //   int    消息接受者
												"type": 2,                //  int    消息类型(1:文本 2.图片 3.视频 5.礼物)
												"content": imgObj, //string  
												"msgToken": JSON.stringify(nowTime),// string  
												"retry":false,//  是否重发状态
												"attach":{name:nickname,head:headpic},
												"devId":systemId(),
												"devType":system(),
												"productType":productType(),
											})
											// console.log(JSON.parse(array))
											
											var arr = sendD201(array);
											// --------socket-login---------------
											// console.log(that.$Socket.isconnect)
											// console.log(this.$Socket)
											if(that.$Socket.isconnect==false){
												that.$Socket.onReload()
											}
											that.$Socket.nsend(arr)
											that.$Socket.eventPatch.onMsg((msg,sk)=>{    //监听是否接受消息
												// console.log(msg)
												// console.log(sk)
												 var fileReader = new FileReader();
												     fileReader.onload = function (progressEvent) {
												     	var arrayBuffer = this.result; // arrayBuffer即为blob对应的arrayBuffer
												     	var HeadRecv = new Uint32Array(arrayBuffer, 0, 3);
												     	var strArray = new Uint8Array(arrayBuffer, 12, HeadRecv[0] - 12 - 1);
												     	var str = new TextDecoder().decode(strArray);//{"code":-1,"error":"用户名或密码错误"}
												     	// console.log(HeadRecv[1],JSON.parse(str))
												     	//to do
														// console.log(HeadRecv[1])
														console.log(JSON.parse(str))
														var msgdata =JSON.parse(str);
														if(HeadRecv[1]==20002){
															if(msgdata.code==0){
																that.inputBg='';
																that.inputMsg='';
																that.getChatMsgData()//拉取消息
															}
															// that.money=msgdata.price;
															// uni.setStorage({
															// 	key: 'storage_login_str',
															// 	data: str,
															// 	success: function () {
															// 		console.log('success');
															// 	}
															// });
														}else if(HeadRecv[1]==10010){
															uni.showToast({
																title: '登录信息过期，请重新登录',
																duration: 1500,
																icon:"none",
																success: function () {
																		// uni.navigateTo({
																		// 	url: '/pages/startup/startup'
																		// });
																		navigateTo('/pages/startup/startup',null);
																}
															});
															
														}
												     	
												     };
												     fileReader.readAsArrayBuffer(msg.data);
											})
											// ----------------
											
										}else{
											uni.showToast({
												title: resObj.msg,
												duration: 1500,
												icon:"none",
												success:function(res){
													
												}
											});
										}
										
										// that.getMyInfoMsg()
										
									}
								})
								//to do-----------
							}
						});

					}
				});
				// --------------------
			},
			getMsgPrice:function(){//获取聊天信息----价格
				var that =this;
				// -------------
				var array =JSON.stringify({	
					"useridx": this.tabbarLoginData.useridx,
					"anchoridx": Number(this.chatObjUseridx),
				})
				// console.log(array)
				var arr = sendD17(array);
				// --------socket-login---------------
				// console.log(this.$Socket.isconnect)
				// console.log(this.$Socket)
				if(this.$Socket.isconnect==false){
					this.$Socket.onReload()
				}
				this.$Socket.nsend(arr)
				this.$Socket.eventPatch.onMsg((msg,sk)=>{    //监听是否接受消息
					// console.log(msg)
					// console.log(sk)
					 var fileReader = new FileReader();
					     fileReader.onload = function (progressEvent) {
					     	var arrayBuffer = this.result; // arrayBuffer即为blob对应的arrayBuffer
					     	var HeadRecv = new Uint32Array(arrayBuffer, 0, 3);
					     	var strArray = new Uint8Array(arrayBuffer, 12, HeadRecv[0] - 12 - 1);
					     	var str = new TextDecoder().decode(strArray);//{"code":-1,"error":"用户名或密码错误"}
					     	// console.log(HeadRecv[1],JSON.parse(str))
					     	//to do
							// console.log(HeadRecv[1])
							// console.log(JSON.parse(str))
							var msgdata =JSON.parse(str);
							if(HeadRecv[1]==11018){
								that.money=msgdata.price;
								// uni.setStorage({
								// 	key: 'storage_login_str',
								// 	data: str,
								// 	success: function () {
								// 		console.log('success');
								// 	}
								// });
							}else if(HeadRecv[1]==10010){
								uni.showToast({
									title: '登录信息过期，请重新登录',
									duration: 1500,
									icon:"none",
									success: function () {
											// uni.navigateTo({
											// 	url: '/pages/startup/startup'
											// });
											navigateTo('/pages/startup/startup',null);
									}
								});
								
							}
					     	
					     };
					     fileReader.readAsArrayBuffer(msg.data);
				})
				// ----------------
			},
			getChatMsgData:function(){//拉取聊天信息
				var that =this;
				// -------------
				// console.log(this.chatObjUseridx)
				// this.chatObjNickname=option.nickname;
				// this.chatObjHeadpic=option.headpic;
				// this.chatObjOnline=option.online;
				var array =JSON.stringify({	
					"appId": 100,            //APP ID
					"msgId": 0,  //消息ID
					"useridx": Number(this.tabbarLoginData.useridx),       //用户ID
					"toUseridx":Number(this.chatObjUseridx),
				})
				
				// console.log(JSON.parse(array))
				var arr = sendD217(array);
				// --------socket-login---------------
				// console.log(this.$Socket.isconnect)
				// console.log(this.$Socket)
				if(this.$Socket.isconnect==false){
					this.$Socket.onReload()
				}
				this.$Socket.nsend(arr)
				this.$Socket.eventPatch.onMsg((msg,sk)=>{    //监听是否接受消息
					// console.log(msg)
					// console.log(sk)
					 var fileReader = new FileReader();
					     fileReader.onload = function (progressEvent) {
					     	var arrayBuffer = this.result; // arrayBuffer即为blob对应的arrayBuffer
					     	var HeadRecv = new Uint32Array(arrayBuffer, 0, 3);
					     	var strArray = new Uint8Array(arrayBuffer, 12, HeadRecv[0] - 12 - 1);
					     	var str = new TextDecoder().decode(strArray);//{"code":-1,"error":"用户名或密码错误"}
					     	// console.log(HeadRecv[1],JSON.parse(str))
					     	//to do
							// console.log(HeadRecv[1])
							// console.log(JSON.parse(str))
							var msgdata =JSON.parse(str);
							if(HeadRecv[1]==20018){
								if(msgdata.code==0){
									// console.log("拉取成功")
									// console.log(msgdata)
									// console.log(that.tabbarLoginData.useridx)
									msgdata.msgs.forEach(function (value,index) {
										value.nowTime = new Date(value.timestamp*1000).getHours()+":"+new Date(value.timestamp).getMinutes();
										if(value.useridx==that.tabbarLoginData.useridx){//direction 方向 0为自己 1 为当前聊天对象 photo 
											value.direction = 0
											value.photo = ''
										}else{
											value.direction = 1
											value.photo = that.chatObjHeadpic
										}
										
										if(value.type==5){//1:文本 2.图片 3.视频 5.礼物 6.作品
											that.NoGiftsData.forEach(function (value1,index1){
												if(value.attach.giftId==value1.giftId){
													value.giftPhoto = value1.iconCartoon  //webp
												}
											})
										}else if(value.type==2){
											value.content=JSON.parse(value.content)
											value.giftPhoto = ''
										}else if(value.type==3){
											value.content=JSON.parse(value.content)
											// console.log(value)
											value.giftPhoto = ''
										}else if(value.type==6){
											value.content=JSON.parse(value.content)
											// console.log(value)
											value.giftPhoto = ''
										}else{
											value.giftPhoto = ''
										}
									});
									that.chatNewMsgData=msgdata
									// console.log(msgdata)
									// console.log(document.getElementById("center").clientHeight)
									// console.log(document.getElementById("chat").clientHeight)
									// console.log(document.getElementById("chat").scrollTop)
									if(document.getElementById("chat").clientHeight!=null){
										document.getElementById("center").scrollTop = document.getElementById("chat").clientHeight-document.getElementById("center").clientHeight;
									}
								}
								
								
							}else if(HeadRecv[1]==10010){
								uni.showToast({
									title: '登录信息过期，请重新登录',
									duration: 1500,
									icon:"none",
									success: function () {
											// uni.navigateTo({
											// 	url: '/pages/startup/startup'
											// });
											navigateTo('/pages/startup/startup',null);
									}
								});
								
							}else if(HeadRecv[1]==20003){
								console.log('收取信息')
								// 收取信息成功--------
								var array =JSON.stringify({	
									"appId": 100,            //APP ID
									"msgId": 0,  //消息ID
									"useridx": Number(that.tabbarLoginData.useridx),       //用户ID
									"fromUseridx":Number(that.tabbarLoginData.useridx),
									"toUseridx":Number(that.chatObjUseridx),
								})
								// console.log(JSON.parse(array))
								var arr = sendD204(array);
								// --------socket-login---------------
								// console.log(this.$Socket.isconnect)
								// console.log(this.$Socket)
								if(that.$Socket.isconnect==false){
									that.$Socket.onReload()
								}
								that.$Socket.nsend(arr)
								that.getChatMsgData()
								// --------------收取信息成功
								
							}
					     	
					     };
					     fileReader.readAsArrayBuffer(msg.data);
				})
				// -------
			},
			setScrollTop:function(){
				document.getElementById("center").scrollTop = document.getElementById("chat").clientHeight-document.getElementById("center").clientHeight;
			},
			goWatch:function(item){
				if(item.type==6){
					console.log(item)

				}
			},
			//-----------------------跳转支付页面----------------------------------------------
			goPay:function(){
				// uni.navigateTo({
				// 	url: '/pages/paymoney/paymoney'
				// })
				navigateTo('/pages/paymoney/paymoney',null);
			},
			//-----------------------跳转支付页面----------------------------------------------
		}
	}
</script>

<style lang="scss">
page{
	width: 100%;
	height: 100%;
	background: #191919;
}
.main{
	width:100%;
	height:100%;
	.content{
		width:100%;
		height:100%;
		display:flex;
		flex-direction:column;
		align-items:center;
		.top{
			width:100%;
			height: 100rpx;
			background: #252525;
			display:flex;
			flex-direction:row;
			justify-content:space-between;
			align-items:center;
			.left{
				display:flex;
				flex-direction:row;
				align-items:center;
				width:30rpx;
				height:30rpx;
				margin-left:29rpx;
				padding:10rpx;
				.img{
					width:30rpx;
					height: 30rpx;
				}
			}
			.center1{
				position:absolute;
				left:40%;
				.title{
					display:flex;
					flex-direction:row;
					align-items:center;
					.spot{
						display: inline-block;
						vertical-align: middle;
						margin-right: 12rpx;
						height: 12rpx;
						width: 12rpx;
						background: #00FF2A;
						border-radius: 50%;
					}
					.p{
						color: #FFFFFF;
						font-size: 26rpx;
						font-weight: 500;
					}
				}
			}
			.right{
				margin-right:28rpx;
				.box{
					display:flex;
					justify-content:center;
					align-items:center;
					heigth: 40rpx;
					background:rgba(0,0,0,0.5);
					border-radius: 6rpx;
					.img{
						width:30rpx;
						height:22rpx;
						margin-right: 13rpx;
						margin-left: 20rpx;
						margin-top:14rpx;
						margin-bottom:14rpx;
						vertical-align: text-bottom;
					}
					.p{
						color: #FFD600;
						font-size: 26rpx;
						font-weight: 500;
						line-height: 22rpx;
						margin-right: 18rpx;
						margin-top:14rpx;
						margin-bottom:14rpx;
					}
				}
			}
		}
		.center{
			width:100%;
			flex: 1;
			display: flex;
			flex-direction: column;
			align-items:center;
			overflow-y:scroll;
			.chat{
				width:100%;
				
				.span_hi{
					margin-top: 39rpx;
					height: 62rpx;
					display:flex;
					flex-direction: column;
					align-items:center;
					.p{
						line-height:36rpx;
						color:#ACACAC;
						font-size:26rpx;
						font-weight:400;
					}
				}
				.span_date{
					margin: 28rpx 0rpx 35rpx 0rpx;
					height: 30rpx;
					display:flex;
					flex-direction: column;
					align-items:center;
					.p{
						color: #FFFFFF;
						font-size: 20rpx;
						font-weight: 400;
						line-height: 36rpx;
						border-radius: 15rpx;
						background: rgba(172,172,172,0.3);
						padding:6rpx 13rpx 6rpx 14rpx;
						// margin-bottom:12rpx;
					}
				}
				.span_chat{
					// display:flex;
					// flex-direction: row;
					// align-items: flex-start;
					// justify-content: flex-start;
					.left{
						display:flex;
						flex-direction: row;
						align-items: flex-start;
						padding:0rpx 28rpx 0rpx 28rpx;
						margin-bottom:16rpx;
						.img{
							width:50rpx;
							height: 50rpx;
							border-radius:50%;
							background: #C0C0C0;
							margin-right: 8rpx;
						}
						.div{
							max-width: 418rpx;
							// background: #FFFFFF;
							border-radius:8rpx;
							// padding:16rpx 16rpx 16rpx 16rpx;
							display:flex;
							// flex-direction: column;
							.p{
								padding:16rpx 16rpx 16rpx 16rpx;
								color: #000000;
								font-size: 28rpx;
								font-weight: 200;
								line-height: 36rpx;
								background: #FFFFFF;
								border-radius:8rpx;
								// margin:16rpx 26rpx 16rpx 25rpx;
							}
							.png{
								width: 280rpx;
								height: 280rpx;
								border-radius: 8rpx;
							}
							// .pngPhoto{
							// 	width: 110rpx;
							// 	height: 154rpx;
							// 	border-radius: 8rpx;
							// }
						}
						.div6{
							max-width: 418rpx;
							height:240rpx;
							display: flex;
							justify-content: center;
							align-items: center;
							.img6{
								height:240rpx;
								// width: 240rpx;
							}
							.p6{
								margin-left:10rpx;
								font-size: 28rpx;
								display: -webkit-box;
								-webkit-box-orient: vertical;
								-webkit-line-clamp: 5;//几行省略就写几
								overflow: hidden;
							}
						}
						
						.p2{
							align-self:flex-end;
							color: #ACACAC;
							font-size: 16rpx;
							font-weight: 200;
							margin-left: 14rpx;
							// line-height:36px;
						}
					}
					.right{
						display:flex;
						flex-direction: row-reverse;
						align-items: flex-end;
						padding:0rpx 28rpx 0rpx 28rpx;
						margin-bottom:16rpx;
						.img{
							// width:50rpx;
							// height: 50rpx;
							// border-radius:50%;
							// background: #C0C0C0;
							// margin-right: 8rpx;
							display: none;
						}
						.div{
							max-width: 418rpx;
							// background: #343434;
							border-radius:8rpx;
							// padding:16rpx 26rpx 16rpx 25rpx;
							display:flex;
							flex-direction: column;
							.p{
								padding:16rpx 16rpx 16rpx 16rpx;
								color: #FFFFFF;
								font-size: 28rpx;
								font-weight: 200;
								line-height: 36rpx;
								background: #343434;
								border-radius:8rpx;
							}
							.png{
								width: 280rpx;
								height: 280rpx;
								border-radius: 8rpx;
							}
						}
						.div6{
							max-width: 418rpx;
							height:240rpx;
							display: flex;
							justify-content: center;
							align-items: center;
							.img6{
								height:240rpx;
								// width: 240rpx;
							}
							.p6{
								margin-left:10rpx;
								font-size: 28rpx;
								display: -webkit-box;
								-webkit-box-orient: vertical;
								-webkit-line-clamp: 5;//几行省略就写几
								overflow: hidden;
							}
						}
						.p2{
							align-self:flex-end;
							color: #ACACAC;
							font-size: 16rpx;
							font-weight: 200;
							margin-right: 14rpx;
							// line-height:36px;
						}
					}
					
				}
			}
		}
		.bottom{
			width:100%;
			height: 90rpx;
			background:#252525;
			display:flex;
			flex-direction:row;
			align-items:center;
			justify-content:flex-start;
			position: relative;
			.img{
				width: 46rpx;
				height: 46rpx;
				margin-left: 28rpx;
			}
			.p{
				width: 2rpx;
				height: 46rpx;
				background: rgba(255,255,255,0.5);
				margin: 0rpx 21rpx 0rpx 20rpx;
			}
			.img1{
				width: 46rpx;
				height: 46rpx;
				margin-right: 28rpx;
			}
			.span{
				display: flex;
				flex-direction:row;
				align-items:center;
				justify-content:flex-start;
				.p1{
					color: #ACACAC;
					font-size: 26rpx;
					font-weight: 400;
					line-height: 36rpx;
				}
				.img2{
					width: 30rpx;
					height: 22rpx;
					vertical-align: middle;
					margin:0rpx 5rpx 0rpx 5rpx;
				}
			}
			.send{
				width:46rpx;
				height: 46rpx;
				margin-left:260rpx;
			}
			.input{
				left: 184rpx;
				width: 420rpx;
				position: absolute;
				color: #fff;
			}
		}
		.gift{
			width: 100%;
			height:395rpx;
			.swiperArea{
				// padding:0 25rpx;
				height: 305rpx;
				.swiper{
					width: 100%;
					height: 100%;
					.swiper-item{
						height: 100%;
						display: flex;
						justify-content: flex-start;
						align-items: center;
						flex-wrap: wrap;
						overflow-y: scroll;
						.listPer{
							width: 240rpx;
							// height: 160rpx;
							color: #fff;
							margin-top: 20rpx;
							margin-bottom: 8rpx;
							display: flex;
							flex-direction:column;
							align-items: center;
							margin-left: 10rpx;
							.gift_img{ // 礼物图片div大小
								width: 140rpx;
								height: 140rpx;
								.photo{
									width: 140rpx;
									height: 140rpx;
								}
							}
							.gift_name{
								font-size:20rpx;
								color:rgba(116,116,116,1);
								line-height:36rpx;
							}
							.gift_num{
								display: flex;
								justify-content: center;
								align-items: center;
								.img{
									width:20rpx;
									height:14rpx;
									margin-right: 5rpx;
								}
								.text{
									font-size:18rpx;
									font-family:PingFang TC;
									font-weight:400;
									color:rgba(255,255,255,1);
									line-height:36rpx;
								}
							}
						}
					}				
				}
			}
			.tab{
				width: 100%;
				overflow-x: scroll;
				height: 90rpx;
				background: #191919;
				display:flex;
				align-items:center;
				.item{
					color: #747474;
					font-size: 26rpx;
					font-weight: 400;
					padding:32rpx 40rpx 33rpx 40rpx;
					height: 25rpx;
					line-height: 36rpx;
					white-space:nowrap
				}
				.tabActive{
					color:#FFFFFF;
					font-size: 26rpx;
					font-weight: 400;
					margin:0rpx 40rpx 0rpx 40rpx;
					height: 25rpx;
					line-height: 36rpx;
					white-space:nowrap
				}
			}
		}
		
	}
}
</style>
