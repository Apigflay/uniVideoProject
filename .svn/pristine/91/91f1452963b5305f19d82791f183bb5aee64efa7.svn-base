<template>
	<view class="content">
		<view class="nav">
			<image class="back" src="../../static/imgs/more1w.png" mode="" @click="goBackPage"></image>
			<text class="title">收益管理</text>
			<text class="tip" @click="goChatPage">私讯</text>
		</view>
		<scroll-view scroll-y="true" @scrolltolower="getNewmsg" class="mainArea">
			<view class="totalCount">
				<select class="select" v-model="searchTime" @change="getSearch()">
				  <option class="op" v-for="item of getDate" :key="item" :id="item" :value="item">{{item}}</option>
				</select>
				<text class="num">合计收益：{{model1Data.allcoin}}</text>
			</view>
			<view class="per" v-for="(item,index) in model2Data" :key="index">
				<image class="img" :src="item.SmallPic" mode=""></image>
				<view class="msgArea">
					<view class="intro1">
						<text class="left1">{{item.MyName}}</text>
						<text>{{item.Descript}}</text>
					</view>
					<!-- <view class="intro2">
						<text> 22</text>
					</view> -->
					<view class="intro3">
						<text class="left1">{{item.lastdate}}</text>
						<text>{{item.lastTime}}</text>
					</view>
					<!-- <image class="video" :src="item.SmallPic" mode=""></image> -->
					<text class="num">+{{item.Coin}}</text>
				</view>
			</view>
		
		</scroll-view>
	</view>
</template>

<script>
	import {encrypt,decrypt,system,systemId,base64ToArrayBuffer,sendData,sendD,work,sendD07,navigateTo} from "../../lib/js/GlobalFunction.js"
	export default {
		data() {
			return {
				tabbarLoginData: null, // 获取页面用户参数
				getDate: null, // 获取等到的时期数组
				UserIdx: null, // 当前用户IDX
				page: 1, // 当前页码
				model1Data: null, // 获取的页码加载数据
				model2Data: null, // 获取用户解锁视频的时间然后写入的数组
				model3Data: null, // 视频滚动加载后加载的新数据
				searchTime: '', // 加载页面信息时需要的时间参数
			};
		},
		
		onLoad:function() {//监听页面加载，其参数为上个页面传递的数据，参数类型为Object
				// var option=JSON.parse(decrypt(decodeURIComponent(obj.action)))
				this.getTime(); // 视频剩余时间
				this.getLoginMsg(); // 获取用户登录信息
				this.getInitMsg(); // 初始化加载页面列表信息
				
		},
		
		
		methods:{
			//----------------------获取当前页面用户信息---------------------------------------------------------
			getLoginMsg:function(){ // 登录信息
				var that = this;
				uni.getStorage({
					key: 'storage_login_str',
					success: function (res) {
						that.tabbarLoginData = JSON.parse(res.data);
						// console.log(that.tabbarLoginData.useridx);
						that.UserIdx = that.tabbarLoginData.useridx;
						if(that.tabbarLoginData.isAnchor==false){
							that.isAnchor = false;
						}
					}
				});
			},
			//----------------------获取当前页面用户信息---------------------------------------------------------
			
			//----------------------获取页面数据信息---------------------------------------------------------
			getInitMsg:function(){ // 获取搜索页面传来的参数
				console.log(this.searchTime);
				var array=base64ToArrayBuffer(encrypt(JSON.stringify({
					userIdx: this.UserIdx, // int 类型
					Page: this.page, // int  当前页数
					Time: this.searchTime
					
				})))
				var res = JSON.parse(decrypt(sendData('POST',this.GLOBAL.urlPoint+'/userinfo/GetAnchorProfitList',array)));
				if(res.code==100){
					console.log(res.data);
					this.model1Data = res.data;
					this.getUnlockTime(); // 获取用户解锁视频的时间然后写入数组
				}
			},
			//----------------------获取页面数据信息------------------------------------------------------------------
			
			//------------------------------查询时间范围------------------------------------------------------------
			getTime:function(){ // 
				var date_list = [];
				//第一个参数传递日期，第二个参数传递num，及要返回最近的年月， 第三个参数传递一个数组用于保存日期，第四个参数固定不变
				getLastMonthYestdy(new Date(),12, date_list, true);
				// console.log(date_list);
				// $scope.dateTypeList = date_list;
				// $scope.dateType = $scope.dateTypeList[0];
				
				//获取最近六个月的日期如 ["2019年04月", "2019年03月", "2019年02月", "2019年01月", "2018年12月", "2018年11月"]
				function getLastMonthYestdy(da, num, date_list, flag) {
				
				    var date = new Date(da);
				
				    var daysInMonth = new Array([0], [31], [28], [31], [30], [31], [30], [31], [31], [30], [31], [30], [31]);
				    var strYear = date.getFullYear();
				    var strDay = date.getDate();
				    var strMonth = date.getMonth() + 1;
				
				    if (flag === true){
				        strMonth = strMonth > 9 ? strMonth : "0"+strMonth;
				        var str = strYear+"-"+strMonth;
				        date_list.push(str);
				    }
				
				    if (strYear % 4 === 0 && strYear % 100 !== 0) {//一、解决闰年平年的二月份天数   //平年28天、闰年29天//能被4整除且不能被100整除的为闰年
				        daysInMonth[2] = 29;
				    }
				
				    if (strMonth - 1 === 0) //二、解决跨年问题
				    {
				        strYear -= 1;
				        strMonth = 12;
				    } else {
				        strMonth -= 1;
				    }
				
				    // strDay = daysInMonth[strMonth] >= strDay ? strDay : daysInMonth[strMonth];
				    strDay = Math.min(strDay, daysInMonth[strMonth]);   //三、前一个月日期不一定和今天同一号，例如3.31的前一个月日期是2.28；9.30前一个月日期是8.30
				
				    //给个位数的月、日补零
				    if (strMonth < 10){
				        strMonth = "0" + strMonth;
				    }
				
				    if (strDay < 10) {
				        strDay = "0" + strDay;
				    }
				
				    var datastr = strYear + "-" + strMonth + "-" + strDay;
				    var datastr1 = strYear.toString() + "-" + strMonth.toString();
				
				    date_list.push(datastr1);
				    num -= 1;
				
				    if (num > 1){
				        getLastMonthYestdy(datastr, num, date_list, false)
				    }
				}
				console.log(date_list)
				this.getDate = date_list;
				this.searchTime = date_list[0]; // 给初始加载页面设置事件值
				
			},
			//------------------------------查询时间范围------------------------------------------------------------
			
			//------------------------------用户解锁时间------------------------------------------------------------
			getUnlockTime:function(){
				
				var jRes=JSON.parse(JSON.stringify(this.model1Data.list))
				jRes.forEach(function (value,index) {
					var month = new Date(value.TradeDate).getMonth()+1;
					var day = new Date(value.TradeDate).getDate();
					value.lastdate=month+'-'+day;
					var hours = new Date(value.TradeDate).getHours();
					var minutes = new Date(value.TradeDate).getMinutes();
					value.lastTime=hours+':'+minutes;
				});
				this.model2Data=jRes;
				// console.log(jRes)
				console.log(this.model2Data)
			},
			//------------------------------用户解锁时间------------------------------------------------------------
			
			//---------------------------------搜索时间改变后重新搜索-----------------------------------------------------
			getSearch:function(){
				console.log(this.searchTime);
				var array=base64ToArrayBuffer(encrypt(JSON.stringify({
					userIdx: this.UserIdx, // int 类型
					Page: this.page, // int  当前页数
					Time: this.searchTime
					
				})))
				var res = JSON.parse(decrypt(sendData('POST',this.GLOBAL.urlPoint+'/userinfo/GetAnchorProfitList',array)));
				if(res.code==100){
					console.log(res.data);
					this.model1Data = res.data;
					this.getUnlockTime(); // 获取用户解锁视频的时间然后写入数组 
				}
			},
			//---------------------------------搜索时间改变后重新搜索-----------------------------------------------------
			
			//---------------------------------滚动加载-----------------------------------------------------
			getNewmsg:function(){
				this.page++;
				console.log(this.page);
				console.log(this.searchTime);
				var array=base64ToArrayBuffer(encrypt(JSON.stringify({
					userIdx: this.UserIdx, // int 类型
					Page: this.page, // int  当前页数
					Time: this.searchTime
					
				})))
				var res = JSON.parse(decrypt(sendData('POST',this.GLOBAL.urlPoint+'/userinfo/GetAnchorProfitList',array)));
				if(res.code==100){
					// console.log(res.data.list);
					this.model3Data = res.data.list;
					this.model2Data.push.apply(this.model2Data,this.model3Data);
					console.log(this.model2Data);
				}
			},
			//---------------------------------滚动加载-----------------------------------------------------
			
			goBackPage:function(){//收益管理返回
				// uni.navigateTo({
				// 	url: '/pages/anchorme/anchorme'
				// });
				navigateTo('/pages/anchorme/anchorme',null);
			},
			goChatPage:function(){//收益管理私讯
				// uni.navigateTo({
				// 	url: '/pages/anchorme/anchorme'
				// });
			}
			
		}
	}
</script>

<style lang="scss">
page{
	width: 100%;
	height: 100%;
}
.content{
	width: 100%;
	height: 100%;
	display: flex;
	flex-direction: column;
	.nav{
		height: 100rpx;
		background:rgba(37,37,37,1);
		display: flex;
		justify-content: space-between;
		align-items: center;
		.back{
			height: 36rpx;
			width: 36rpx;
			padding: 10rpx;
			margin-left: 19rpx;
		}
		.title{
			font-size:30rpx;
			color:rgba(255,255,255,1);
		}
		.tip{
			padding: 10rpx;
			margin-right: 19rpx;
			font-size:30rpx;
			color:rgba(255,214,0,1);
		}
	}
	.mainArea{
		flex: 1;
		background:rgba(25,25,25,1);
		overflow-y:scroll;
		.totalCount{
			display: flex;
			justify-content: space-between;
			align-items: center;
			height: 36rpx;
			margin-top: 28rpx;
			margin-bottom:16rpx;
			.select{
				margin-left: 28rpx;
				width: 170rpx;
				height: 36rpx;
				background:rgba(116,116,116,1);
				border-radius:18rpx;
				font-size:24rpx;
				color:rgba(255,255,255,1);
				line-height: 36rpx;
				border: 0;  // 去除未选中状态边框
				outline: none; // 去除选中状态边框
				text-indent: 20rpx;
				.op{
					border: 0;  // 去除未选中状态边框
					outline: none; // 去除选中状态边框
					font-size:24rpx;
				}
			}
			.num{
				font-size:24rpx;
				color:rgba(255,255,255,1);
				margin-right: 28rpx;
			}
		}
		.per{
			width: 694rpx;
			height: 117rpx;
			padding-top:44rpx;
			margin: auto;
			display: flex;
			justify-content: space-between;
			.img{
				width:60rpx;
				height:60rpx;
				background:rgba(100,100,100,1);
				border-radius:50%;
			}
			.msgArea{
				width: 613rpx;
				height: 115rpx;
				border-bottom: 1rpx solid rgba(52,52,52,1);
				position: relative;
				.intro1{
					font-size:26rpx;
					color:rgba(255,255,255,1);
					height: 26rpx;
					line-height: 26rpx;
					.left1{
						margin-right: 21rpx;
					}
					margin-bottom: 22rpx;
				}
				.intro3{
					font-size:22rpx;
					color:rgba(172,172,172,1);
					margin-top: 10rpx;
					.left1{
						margin-right: 21rpx;
					}
				}
				.video{
					position: absolute;
					width:46rpx;
					height:64rpx;
					border-radius:8rpx;
					right: 0;
					top: 0rpx;
				}
				.num{
					position: absolute;
					height:26rpx;
					font-size:26rpx;
					color:rgba(255,214,0,1);
					right: 0;
					bottom: 59rpx;
				}
			}
		}
	}
}
</style>
