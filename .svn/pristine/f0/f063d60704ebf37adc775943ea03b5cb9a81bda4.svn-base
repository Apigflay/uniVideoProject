<template>
<view class="contentBox">
	<scroll-view scroll-y="true" @scrolltolower="getNewlist" @scroll="getScrollTopMsg" class="scrollView">
			<!-- top -->
		<view class="main">
			<view class="top">
				<image class="img" src="../../static/pictures/shezhi_1.png" @click="goDatasetPage"></image>
				<view class="imgArea">
					<image class="size" src="../../static/pictures/lcon_1.png"></image>
					<text class="font">{{tabbarLoginData.cash}}</text>
				</view>
			</view>
			<!-- top -->
			<!-- top 上推 出现层 -->
			<view v-if="show" class="move">
				<text class="p">{{name}}</text>
			</view>
			<view v-if="show1" class="move1">
				<text class="p">已买商品</text>
			</view>
			<!-- top 上推 出现层 -->
			<!-- top 背景 -->
			<view :style="{backgroundImage: 'url(' + tabbarLoginData.background + ')', backgroundSize:'contain',backgroundPosition:'center',backgroundRepeat:'no-repeat'}" class="top_bj"></view>
			<!-- top 背景 -->
			<!-- center -->
			<view class="center">
				<image :src="tabbarLoginData.headpic" class="photo"></image>
				<view class="follow" @click="goFollow()">
					<text class="p">{{mymsg.Follow}}</text>
					<text class="p1">关注中</text>
				</view>
				<view class="follow" @click="goFans()">
					<text class="p">{{mymsg.Fans}}</text>
					<text class="p1">粉丝数</text>
				</view>
				<view class="edit" @click="goUpdateMsg">
					<image src="../../static/pictures/edit_1.png" class="img"></image>
					<text class="p">编辑</text>
				</view>
			</view>
			<!-- center -->
			<!-- center1 -->
			<view class="center1">
				
			</view>
			<!-- name 账号-->
			<view class="name">
				{{tabbarLoginData.nickname}}
			</view>
			<!-- name -->
			<!-- 商品，收益 管理 -->
			<view class="commodity " @click="goProductPage">
				<text class="p">商品管理</text>
				<image class="img" src="../../static/pictures/gengduo_1.png"></image>
			</view>
			<view class="profit"  @click="goRecivePage">
				<text class="p">收益管理</text>
				<image class="img" src="../../static/pictures/gengduo_1.png"></image>
			</view>
			<!-- 商品，收益 管理 -->
			<!-- purchased  已购买商品 -->
			<view class="purchased ">
				<view class="p">
					<text class="p1">已买商品</text>
				</view>
				<view class="list">
					<view class="pro" v-for="(item,index) in model1Data" :key="index" :id="index" @click="goVideolist(item)">
						<image :src="item.SmallPic" class="photo"></image>
						<view class="id">
							<text class="p1">{{item.MyName}}</text>
							<view v-show=item.status class="status"></view>
						</view>
						<text class="p2">{{item.Cont}}贴文</text>
					</view>
				</view>
			</view>
			<!-- purchased  -->
			<!-- TagBar -->
			<view class="tabbarArea">
				<view class="per" v-for="(item,index) in tabbarData" :key="index" :id="index" @click="getClickPer">
					<image class="img" :src="item.imgsrcW" mode=""></image>
				</view>
			</view>
		</view>
	</scroll-view>
</view>
</template>

<script>
	import {encrypt,decrypt,system,systemId,base64ToArrayBuffer,sendData,sendD,work,sendD07,navigateTo} from "../../lib/js/GlobalFunction.js"
	export default {
		data() {
			return {
				show: false,
				show1: false,
				UserIdx: null, // 用户IDX
				AnchorIdx: null, // 主播IDX
				Page: 1, // 刷新加载数据时的当前页数
				Type: 0, // 当前连接接口的类型                     —0列表 1-点击主播头像获取列表
				pageId: 6, // 页面跳转时需要的本页面的ID
				// tabbar--
				tabbarLoginData:null,//loginMsg
				isAnchor:null,//是否为主播
				tabbarCurrent:0,//点击的索引
				tabbarData:[{imgsrcB:'../../static/imgs/room1w.png',imgsrcW:'../../static/imgs/room1w.png',text:'1'},
					{imgsrcB:'../../static/imgs/fang1w.png',imgsrcW:'../../static/imgs/fang1w.png',text:'2'},
					{imgsrcB:'../../static/imgs/mail1w.png',imgsrcW:'../../static/imgs/mail1w.png',text:'3'},
					{imgsrcB:'../../static/imgs/xin1w.png',imgsrcW:'../../static/imgs/xin1w.png',text:'4'},
					{imgsrcB:'../../static/imgs/my1w.png',imgsrcW:'../../static/imgs/my1y.png',text:'5'}],//
				model1Data: null, // 获取通过接口得到的页面的用户视频列表数据
				model2Data: null ,// 获取通过下拉页面得到的数据 + 与原数据合并(model2Data)
				mymsg: null, // 通过接口获取用户粉丝数关注数余额等数据
			};
				
			},
		
		onLoad:function() {//监听页面加载，其参数为上个页面传递的数据，参数类型为Object
				// var option=JSON.parse(decrypt(decodeURIComponent(obj.action)));
				// console.log(option);
				this.getLoginMsg(); // 获取用户登录信息
				this.getVideo(); // 初始化页面加载用户关注主播的数据.
				this.getMyMsg(); // 获取用户信息
		},
		onPageScroll(){
			// if(document.documentElement.scrollTop>=100){
			// 	this.show = true;
			// }else{
			// 	this.show= false
			// }
			// if(document.documentElement.scrollTop>=310){
			// 	this.show1 = true;
			// }else{
			// 	this.show1= false
			// }
			// this.getBottomNewmsg(); // 计算页面是否滚动到底部
		},
		methods:{
			getLoginMsg:function(){ // 登录信息
				var that = this;
				uni.getStorage({
					key: 'storage_login_str',
					success: function (res) {
						that.tabbarLoginData = JSON.parse(res.data);
						console.log(that.tabbarLoginData);
						that.UserIdx = that.tabbarLoginData.useridx;
						if(that.tabbarLoginData.isAnchor==false){
							that.isAnchor = false;
						}
					}
				});
			},
			
			getMyMsg: function(){  // 获取用户信息
				var array=base64ToArrayBuffer(encrypt(JSON.stringify({
						UserIdx: this.UserIdx, // int
					})))
					
					var res = JSON.parse(decrypt(sendData('POST',this.GLOBAL.urlPoint+'/userinfo/GetCatUserInfo',array)));
					// console.log(res);
					console.log(decrypt('LDZVGiiPVwnl9jDOuakGIOl++yQIKW2fjyGBknmT1/gJzs0TphUg8kGqOoOJzu0c4TqsFDScH3biN0r1HzYESGD2x499MY43QbefVD85YIe0jImPtd8+X7PBbiY4RrQ5'))
					if(res.code==100){
						console.log(res);
						this.mymsg = res.data;
					}
			},
			
			getClickPer:function(e){//tabbar click
				this.tabbarCurrent=e.currentTarget.id;
				console.log(e.currentTarget.id)
				if(e.currentTarget.id==0){
					// console.log("首页点击")
					// uni.navigateTo({
					// 	url: '/pages/home/home'
					// });
					navigateTo('/pages/home/home',null);
				}else if(e.currentTarget.id==1){
					// console.log("搜索点击")
					// uni.navigateTo({
					// 	url: '/pages/search/search'
					// });
					navigateTo('/pages/search/search',null);
				}else if(e.currentTarget.id==2){
					// console.log("信息点击")
					// uni.navigateTo({
					// 	url: '/pages/news/news'
					// });
					navigateTo('/pages/news/news',null);
				}else if(e.currentTarget.id==3){
					// console.log("聊天点击")
					// uni.navigateTo({
					// 	url: '/pages/chat/chat'
					// });
					navigateTo('/pages/chat/chat',null);
				}else if(e.currentTarget.id==4){
					// console.log(this.isAnchor)
					if(this.isAnchor==false){
						// console.log("不是主播")
						// uni.navigateTo({
						// 	url: '/pages/my/my'
						// });
						navigateTo('/pages/my/my',null);
					}else{
						// console.log("是主播")
						// uni.navigateTo({
						// 	url: '/pages/anchorme/anchorme'
						// });
						navigateTo('/pages/anchorme/anchorme',null);
					}
				}
			},
			
			
			// -------------------------获取页面中的用户购买的视频内容---------------------
			getVideo:function(){ // 获取页面中的用户购买的视频内容
				// console.log(decrypt('UVkIwvkixFT3MFiFNKMHspgHjrhUK84gUfsshvWgbFMza3XZ/h9B1ySomcmLQnzebNiTS+D8oTa88Ul0XXfXP02TZIFwKs3wzNKsfhRezHvVgeTzcSf8B6qAOjbrq1C6'))
				// console.log(Number(this.AnchorIdx)); // 主播IDX
				var array=base64ToArrayBuffer(encrypt(JSON.stringify({
						UserIdx: this.UserIdx, // int
						AnchorIdx: 0, // int 主播idx 获取列表时 传0
						Page: this.Page,// int
						Type: this.Type // int
					})))
					
					var res = JSON.parse(decrypt(sendData('POST',this.GLOBAL.urlPoint+'/userinfo/GetBuyList',array)));
					// console.log(res);
					if(res.code==100){
						// console.log(res.data);
						this.model1Data = res.data.list;
					}
			},
			// -------------------------获取页面中的用户购买的视频内容---------------------
			
			//-----------------------------------页面下滑功能----------------------------------
			getBottomNewmsg:function(){ // 页面下滑功能
				//--------------
				var that = this
				window.onscroll = function(){  // 由于需要使用 onPageScroll 无法使用 scroll-view 所以使用onscroll来判断页面是否滚动到底部
				    //变量scrollTop是滚动条滚动时，距离顶部的距离
				    var scrollTop = document.documentElement.scrollTop;
				    //变量windowHeight是可视区的高度
				    var windowHeight = document.documentElement.clientHeight;
				    //变量scrollHeight是滚动条的总高度
				    var scrollHeight = document.documentElement.scrollHeight;
				           //滚动条到底部的条件
						   // console.log(this.GLOBAL);
						if(scrollTop+windowHeight==scrollHeight){
							//写后台加载数据的函数
							// console.log("距顶部"+scrollTop+"可视区高度"+windowHeight+"滚动条总高度"+scrollHeight);
							// console.log(that.GLOBAL.urlPoint);
							that.Page++;
							// console.log(that.UserIdx); // 用户IDX
							// console.log(Number(that.AnchorIdx)); // 主播IDX
							// console.log(that.Page);
							// console.log(decrypt('UVkIwvkixFT3MFiFNKMHspgHjrhUK84gUfsshvWgbFMza3XZ/h9B1ySomcmLQnzebNiTS+D8oTa88Ul0XXfXP02TZIFwKs3wzNKsfhRezHvVgeTzcSf8B6qAOjbrq1C6'))
							// console.log(Number(this.AnchorIdx)); // 主播IDX
							
							// var array=base64ToArrayBuffer(encrypt(JSON.stringify({
							// 		UserIdx: that.UserIdx, // int
							// 		AnchorIdx: 0, // int 主播idx 获取列表时 传0
							// 		Page: that.Page,// int
							// 		Type: 0 // int
							// 	})))
								
								// var res = JSON.parse(decrypt(sendData('POST',that.GLOBAL.urlPoint+'/userinfo/GetBuyList',array)));
								// // console.log(res);
								// if(res.code==100){
								// 	// console.log(res.data);
								// 	that.model2Data = res.data.list;
								// 	that.model1Data.push.apply(that.model1Data,that.model2Data); // 让两个数组合并
								// 	// console.log(that.model1Data);
								// }
						}   
				    }
				//-----------------
			},
			//-----------------------------------页面下滑功能----------------------------------
			
			goVideolist:function(e){ // 跳转到用户购买的主播的视频列表页面
				// uni.navigateTo({
				// 	url: '/pages/unlockvideo/unlockvideo?AnchorName=' + e.MyName + '&AnchorIdx=' + e.AnchorIdx + '&pageId=' + this.pageId
				// });
				var obj = encodeURIComponent(encrypt(JSON.stringify({
					AnchorName: e.MyName,
					AnchorIdx: e.AnchorIdx,
					pageId: this.pageId
				})))
				navigateTo('/pages/unlockvideo/unlockvideo',obj);
			},
			
			goUpdateMsg:function(){ // 编辑资料
				// uni.navigateTo({
				// 	url: '/pages/changeintroduction/changeintroduction'
				// });
				navigateTo('/pages/changeintroduction/changeintroduction',null);
			},
			goProductPage:function(){ // 商品管理页面
				// uni.navigateTo({
				// 	url: '/pages/commoditymanagement/commoditymanagement'
				// });
				navigateTo('/pages/commoditymanagement/commoditymanagement',null);
			},
			goRecivePage:function(){ // 收益管理页面
				// uni.navigateTo({
				// 	url: '/pages/revenuemanagement/revenuemanagement'
				// });	
				navigateTo('/pages/revenuemanagement/revenuemanagement',null);
			},
			goDatasetPage:function(){ // 个人资料设定页面
				// uni.navigateTo({
				// 	url: '/pages/dataset/dataset'
				// });
				navigateTo('/pages/dataset/dataset',null);
			},
			
			//----------------------------跳转粉丝列表页面-------------------------------------
			goFans:function(){
				// uni.navigateTo({
				// 	url: '/pages/fanspopup/fanspopup'
				// });
				navigateTo('/pages/fanspopup/fanspopup',null);
			},
			//----------------------------跳转粉丝列表页面-------------------------------------
			
			//----------------------------跳转关注列表页面-------------------------------------
			goFollow:function(){
				// uni.navigateTo({
				// 	url: '/pages/followpopup/followpopup'
				// });
				navigateTo('/pages/followpopup/followpopup',null);
			},
			//----------------------------跳转关注列表页面-------------------------------------
			
			//------------------------------判断用户是否位主播--------------------------------------
			
			//------------------------------判断用户是否位主播--------------------------------------
			
			getNewlist:function(){
				console.log(111)
				this.Page++;
				var array=base64ToArrayBuffer(encrypt(JSON.stringify({
						UserIdx: this.UserIdx, // int
						AnchorIdx: 0, // int 主播idx 获取列表时 传0
						Page: this.Page,// int
						Type: 0 // int
				})))
				var res = JSON.parse(decrypt(sendData('POST',this.GLOBAL.urlPoint+'/userinfo/GetBuyList',array)));
				// console.log(res);
				if(res.code==100){
					// console.log(res.data);
					this.model2Data = res.data.list;
					this.model1Data.push.apply(this.model1Data,this.model2Data); // 让两个数组合并
					console.log(this.model1Data);
				}
			},
			getScrollTopMsg:function(event){
				if(event.detail.scrollTop>=100){
					this.show = true;
				}else{
					this.show = false;
				}
				if(event.detail.scrollTop>=300){
					this.show1 = true;
				}else{
					this.show1= false;
				}
				
			}
		}
	}
</script>

<style lang="scss">
page{
	width: 100%;
	height: 100%;
	background: #232323;;
}
.contentBox{
	width: 100%;
	height: 100%;
	overflow: hidden;
}
.scrollView{
	width: 100%;
	height: 100%;

.main{
	width: 100%;
	height: 100%;
	// ---背景
	.top_bj{
		height: 400rpx;
		width: 100%;
		// background:url(../../static/pictures/juxing_1.png);
		}
	// ---- 设置部分
	.top{
		height: 150rpx;
		width: 100%;
		position:fixed;
		top: 0;
		left: 0;
		z-index:9999;
		display: flex;
		justify-content: space-between;
		align-items: center;
		.img{
			width: 42rpx;
			height: 40rpx;
			padding: 10rpx;
			margin-left: 25rpx;
			background-image: linear-gradient(rgba(0,0,0,0.5));
			border-radius: 50%;
		}
		.imgArea{
			display: flex;
			justify-content: space-between;
			align-items: center;
			background:rgba(0,0,0,0.5);
			border-radius:6rpx;
			padding:14rpx 9rpx;
			margin-right:28rpx;
			.size{
				width: 30rpx;
				height: 22rpx;
				margin-right: 13rpx;
			}
			.font{
				font-size:26rpx;
				color:rgba(255,214,0,1);
			}
		}
	}
	.move{
		position: fixed;
		top: 0;
		left: 0;
		z-index: 9998;
		display: flex;
		justify-content: center;
		align-items: center;
		width: 100%;
		height: 150rpx;
		background-color:#252525;
		transition: all 5s;
		-webkit-transition: all 5s;	/* Safari 和 Chrome */
		.p{
			color: #FFFFFF;
			font-size: 30rpx;
		}
	}
	.move1{
		position: fixed;
		top: 150rpx;
		left:0;
		z-index: 9998;
		display: flex;
		justify-content: center;
		align-items: center;
		width: 100%;
		height: 50rpx;
		background-color:#343434;
		.p{
			font-size:22rpx;
			color: #FFFFFF;
		}
	}
	// ------- 头像 关注 粉丝部分
	.center,.center1{
		display: flex;
		justify-content: flex-start;
		align-items: flex-start;
		margin-top: -100rpx;
		padding: 0rpx 28rpx 0rpx 28rpx;
		width: 100%;
		height: 100rpx;
		.photo{
			width:160rpx;
			height:160rpx;
			background: #151515;
			border:2px solid rgba(255, 255, 255, 1);
			border-radius:50%;
			margin-right: 23rpx;
		}
		.follow{
			display: flex;
			flex-direction: column;
			align-items:center;
			padding:10rpx;
			margin-top:8rpx;
			margin-left:8rpx;
			.p{
				color: #FFFFFF;
				font-size: 26rpx;
			}
			.p1{
				color: #FFFFFF;
				font-size: 22rpx;
			}
		}
		.edit{
			display: flex;
			justify-content: flex-start;
			align-items: flex-start;
			margin-left:160rpx;
			padding:10rpx;
			padding:11rpx 19rpx;
			border:2px solid rgba(255,255,255,1);
			border-radius:8rpx;
			margin-top:20rpx;
			.img{
				width:29rpx;
				height:29rpx;
				vertical-align: middle;
			}
			.p{
				color: #FFFFFF;
				font-size: 26rpx;
				line-height: 25rpx;
				margin-left: 16rpx;
			}
		}
	}
	.center1{
		background-image: linear-gradient(rgba(255,255,255,0.2), rgba(0,0,0,0.5));
	}
	.name{
		max-width:500rpx;
		overflow: hidden;
		text-overflow:ellipsis;
		white-space: nowrap;
		
		background: #232323;
		padding-top:89rpx;
		padding-left:60rpx;
		padding-bottom:35rpx;
		
		font-size:30rpx;
		color: #FFFFFF;
	
	}
	.commodity{
		// width:100%;
		height: 100rpx;
		background: #252525;
		border-top: 1rpx solid #747474;
		padding: 0rpx 37rpx;
		display:flex;
		align-items:center;
		justify-content:space-between;
		.p{
			color: #FFFFFF;
			font-size: 26rpx;
			line-height: 26rpx;
		}
		.img{
			width: 30rpx;
			height: 30rpx;
			padding: 10rpx;
		}
	}
	.profit{
		height: 100rpx;
		background: #252525;
		border: 1rpx solid #747474;
		padding: 0rpx 37rpx;
		display:flex;
		align-items:center;
		justify-content:space-between;
		.p{
			color: #FFFFFF;
			font-size: 26rpx;
			line-height: 26rpx;
		}
		.img{
			width: 30rpx;
			height: 30rpx;
			padding: 10rpx;
		}
	}
	
	.purchased{
		.p{
			display: flex;
			justify-content: center;
			align-items: center;
			width:100%;
			height:50rpx;
			background-color:#343434;
			.p1{
				font-size: 22rpx;
				color: #FFFFFF;
			}
		}
		.list{
			display: flex;
			flex-direction: row;
			flex-wrap: wrap;
			justify-content: flex-start;
			// align-items:center;
			padding: 0rpx 20rpx;
			.pro{
				display: flex;
				flex-direction:column;
				align-items: center;
				justify-content: center;
				.photo{
					width:220rpx;
					height:220rpx;
					background: #343434;
					border-radius:50%;
					margin:28rpx 8rpx 16rpx 8rpx;
				}
				.id{
					display: flex;
					justify-content: center;
					align-items: center;
					height: 22rpx;
					margin-bottom: 11rpx;
					.p1{
						max-width: 220rpx;
						overflow: hidden;
						text-overflow:ellipsis;
						white-space: nowrap;
						color: #FFFFFF;
						font-size: 22rpx;
						line-height: 22rpx;
					}
					.status{
						height: 14rpx;
						width: 14rpx;
						background: #17FF2A;
						border-radius: 50%;
						margin-left: 9rpx;
					}
				}
				.p2{
					max-width: 220rpx;
					overflow: hidden;
					text-overflow:ellipsis;
					white-space: nowrap;
					color:#747474;
					font-size: 22rpx;
					margin-bottom: 11rpx;
				}
			}
		}
	}
		// --tabbar ---
	.tabbarArea{
		height: 90rpx;
		width: 100%;
		position: fixed;
		bottom: 0;
		left: 0;
		z-index: 9999;
		display: flex;
		justify-content: space-around;
		align-items: center;
		background:rgba(25,25,25,1);
		.per{
			width: 54rpx;
			height: 50rpx;
			.img{
				width: 54rpx;
				height: 50rpx;
			}
		}
	}
}
}
</style>
