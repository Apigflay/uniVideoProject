<template>
	<view class="content">
		<view class="nav">
			<image class="img" src="../../static/imgs/more1w.png" mode="" @click="goBackPage"></image>
			<text class="title">信息编辑</text>
			<text class="save" @click="keepMsg">保存</text>
		</view>
		<view class="bgArea">
			<image class="bg" src="../../static/imgs/19032400.jpg" mode=""></image>
			<view class="phoArea">
				<image class="photo" src="../../static/imgs/bird1.png" mode=""></image>
				<image class="camera" src="../../static/imgs/camera1w.png" mode="" @click="upLoadImg"></image>
			</view>
			<image class="choosebg" src="../../static/imgs/camera1w.png" mode="" @click="upLoadVideo"></image>
		</view>
		<view class="introductionArea">
			<view class="name">
				<text class="text">用户名</text>
				<input class="input" type="text" placeholder="请输入用户名" />
			</view>
			<view class="p">
				<text class="tltle">用户说明</text>
				<text class="num">{{textAreaLegth}}/150</text>
			</view>
			<view class="textArea">
				<textarea class="text" v-model="textArea" placeholder-style="color:rgba(116,116,116,1)" placeholder="" :maxlength="150" @input="getTextLength"/>
			</view>
		</view>
		<!-- <image src="blob:http://localhost:8080/79451176-9fa5-4111-8b39-ba7d898b3850" mode=""></image> -->
		<!-- #ifdef H5
		<InputFile></InputFile>
		#endif --> -->
	</view>
</template>

<script>
	import {encrypt,decrypt,system,systemId,base64ToArrayBuffer,sendData,sendD,work,regMail} from "../../lib/js/GlobalFunction.js"
	export default {
		data() {
			return {
				loginMsgData:null,//登录信息
				textAreaLegth:0,//textarea长度
				textArea:'',//textarea内容
				aaa:null,
			};
		},
		onLoad() {//监听页面加载，其参数为上个页面传递的数据，参数类型为Object
				this.getLoginMsg()//
		},
		methods:{
			getLoginMsg:function(){
				var that = this;
				uni.getStorage({
					key: 'storage_login_str',
					success: function (res) {
						that.loginMsgData = JSON.parse(res.data);
						console.log(that.loginMsgData);
					}
				});
			},
			getTextLength:function(event){//动态获取长度
				this.textAreaLegth=event.target.value.length;
			},
			goBackPage:function(){//返回资料页面
				uni.navigateTo({
					url: '/pages/anchorme/anchorme'
				});
			},
			keepMsg:function(){//保存资料
				
			},
			upLoadImg:function(){//upload HeaderPic

				var that =this;
				// console.log(decrypt('LDZVGiiPVwnl9jDOuakGIK5NSmC6xiKRRlANC2al45nqGKSlK6B6j+D0LqGjdzq78pYny0lH51rkWj5++BIXGppHGlbloAJSTwMGHju8QhNpuwhOf+pSg+BQ3CbC94hFal4gWSSco2VlrvcU0I9yibTxrdWG6HyAPh6Bg3SR6HncnIV8QvqqpuihvBSOg/FUDcrC1v+c8W/K40ZcdIo9FDHS3sc2mx/uIjjR7NUqFGQPhgq4+QuDtqXYzJbmvlv18SE4fBDVVpotMc/sLwXbXYAPnzNaNzOXgqowxo0Ff/pJ8QjJZ8WZYA1Eh1rtREzm'))
				// -----
				// uni.chooseImage({
				// 	success: (chooseImageRes) => {
				// 		console.log(chooseImageRes)
				// 		console.log(chooseImageRes.tempFiles[0])
				// 		uni.request({
				// 			url: this.GLOBAL.urlPoint+'/userinfo/UploadHeaderImg', //仅为示例，并非真实接口地址。
				// 			method:"POST",
				// 			header: {
				// 				'content-type': 'application/x-www-form-urlencoded', //formdata 
				// 			},
				// 			data: {
				// 				picture:chooseImageRes.tempFiles[0],
				// 				userIdx:that.loginMsgData.useridx,
				// 				token:that.loginMsgData.webtoken,
				// 				Type:1,//1-修改头像，2-背景图片
				// 			},
				// 			success: (res) => {
				// 				console.log(res);
				// 				console.log(decrypt(res.data))kf9DWFVBzdrWxd9Jwc9xwFX2x6A9vw0Cokxgcg28Hl4tyhB+R8VP3xcwLBp6yr54
				// 			}
				// 		});
				// 		
				// 	}
				// });
				// ---
				uni.chooseImage({
					count:1,//图片数量
					sizeType:['compressed '],//压缩图
					sourceType:['album','album'],//相册 相机
					success: function (res) {
						console.log(res)
						alert(JSON.stringify(res))
						
						// uni.uploadFile({
						// 	url:that.GLOBAL.urlPoint+'/userinfo/UploadHeaderImg', //仅为示例，非真实的接口地址
						// 	fileType:'image',
						// 	name:'file',
						// 	filePath: res.tempFilePaths[0],
						// 	header:{"Content-Type": "multipart/form-data"},//multipart/form-data。application/x-www-form-urlencoded
						// 	formData: {
						// 		picture:"",
						// 		userIdx:that.loginMsgData.useridx,
						// 		token:that.loginMsgData.webtoken,
						// 		Type:1,//1-修改头像，2-背景图片
						// 	},
						// 	data:{
						// 		picture:"",
						// 		userIdx:that.loginMsgData.useridx,
						// 		token:that.loginMsgData.webtoken,
						// 		Type:1,//1-修改头像，2-背景图片
						// 	},
						// 	success: (uploadFileRes) => {
						// 		console.log(uploadFileRes);
						// 		console.log(decrypt(uploadFileRes.data))
						// 		// console.log(uploadFileRes.data);
						// 	}
						// });
						
						
						
						uni.request({
							url: res.tempFilePaths[0],
							method:'GET',
							responseType: 'arraybuffer',
							success: ress => {
								// console.log(ress)
								// console.log(ress.data)//流
								let base64 = wx.arrayBufferToBase64(ress.data); //把arraybuffer转成base64 
								base64 = 'data:image/jpeg;base64,' + base64 //不加上这串字符，在页面无法显示的哦
								console.log(base64)
								
							
								// ------------------2222
								// 将图片转换为Base64 --2019-8-21更新,加注释
								// url 图片链接或者是blob对象
								// callback 回调函数
								// function getImgToBase64(url,callback){
								//   var canvas = document.createElement('canvas'),
								// 	ctx = canvas.getContext('2d'),
								// 	img = new Image;//通过构造函数来创建的 img 实例，在赋予 src 值后就会立刻下载图片，相比 createElement() 创建 <img> 省去了 append()，也就避免了文档冗余和污染
								//   img.crossOrigin = 'Anonymous';
								//   img.onload = function(){//要先确保图片完整获取到，这是个异步事件
								// 	canvas.height = img.height;//确保canvas的尺寸和图片一样
								// 	canvas.width = img.width;
								// 	ctx.drawImage(img,0,0);//将图片绘制到canvas中
								// 	var dataURL = canvas.toDataURL('image/png');//转换图片为dataURL,传第二个参数可压缩图片,前提是图片格式jpeg或者webp格式的
								// 	callback(dataURL);//调用回调函数
								// 	canvas = null;
								//   };
								//   img.src = url;
								// }
								// 将base64转换为文件对象
								function dataURLtoFile(dataurl, filename) {
								  var arr = dataurl.split(',');
								  var mime = arr[0].match(/:(.*?);/)[1];
								  var bstr = atob(arr[1]);
								  var n = bstr.length; 
								  var u8arr = new Uint8Array(n);
								  while(n--){
									  u8arr[n] = bstr.charCodeAt(n);
								  }
								  // 转换成file对象
								  return new File([u8arr], filename, {type:mime});//FormData File
								  // 转换成成blob对象
								  // return new Blob([u8arr],{type:mime});
								}
								// 将图片转换为base64,再将base64转换成file对象
								var file=dataURLtoFile(base64,'imgHeader')
								console.log(file)
								
								// var path = window.URL.createObjectURL(file);
								// console.log(path)
								// var name = /\.[^\.]+$/.exec(file.name);
								// console.log(name)
								// --------------2222
								// 转二进制
								// function dataURLtoBlob(dataurl) {
								// 	var arr = dataurl.split(','),
								// 	mime = arr[0].match(/:(.*?);/)[1],
								// 	bstr = atob(arr[1]),
								// 	n = bstr.length,
								// 	u8arr = new Uint8Array(n);
								// 	while (n--) {
								// 		u8arr[n] = bstr.charCodeAt(n);
								// 	}
								// 	return new Blob([u8arr], {
								// 		type: mime
								// 	});
								// }
								// var er =dataURLtoBlob(base64);
								// console.log(dataURLtoBlob(base64))

								// var reader = new FileReader();
								// reader.onload = function(e) {
								// var bin = e.target.result;
								// // bin is the binaryString
								// console.log(bin)
								// 	uni.request({
								// 		url: that.GLOBAL.urlPoint+'/userinfo/UploadHeaderImg', //仅为示例，并非真实接口地址。
								// 		method:"POST",
								// 		header: {
								// 			'content-type': 'application/x-www-form-urlencoded', //formdata 
								// 		},
								// 		data: 
								// 		// formData,
								// 		{
								// 			picture:bin,
								// 			userIdx:that.loginMsgData.useridx,
								// 			token:that.loginMsgData.webtoken,
								// 			Type:1,//1-修改头像，2-背景图片
								// 		},
								// 		success: (res) => {
								// 			console.log(res);
								// 			console.log(decrypt(res.data))
								// 		}
								// 	});
								// };
								// reader.readAsBinaryString(file);
								
								var formData = new FormData();
								formData.append('picture',file);
								formData.append('userIdx',that.loginMsgData.useridx);
								formData.append('token',that.loginMsgData.webtoken);
								formData.append('Type',1);
								console.log(formData)
								
								var xhr = new XMLHttpRequest;
								xhr.open('POST','http://60.191.222.11:8044/userinfo/UploadHeaderImg', false);
								xhr.send(formData);
								console.log(xhr.responseText)
								console.log(decrypt('LDZVGiiPVwnl9jDOuakGIK5NSmC6xiKRRlANC2al45nqGKSlK6B6j+D0LqGjdzq78pYny0lH51rkWj5++BIXGppHGlbloAJSTwMGHju8QhNpuwhOf+pSg+BQ3CbC94hFZMAuQxhCr1H5ws+3eySgmU58XoAirgaV9c51gqBrSeTcnIV8QvqqpuihvBSOg/FUDcrC1v+c8W/K40ZcdIo9FDHS3sc2mx/uIjjR7NUqFGRwQayR7Ov+A2V3fIKLUAlcXoN3LWO3A8058QWhXLbsVYAPnzNaNzOXgqowxo0Ff/pJ8QjJZ8WZYA1Eh1rtREzm'))
								// uni.request({
								// 	url: that.GLOBAL.urlPoint+'/userinfo/UploadHeaderImg', //仅为示例，并非真实接口地址。
								// 	method:"POST",
								// 	header: {
								// 		'content-type': 'multipart/form-data', //formdata 
								// 	},
								// 	data: formData,
								// 	// formData,GetType=1  basestr
								// 	// {	
								// 	// 	picture:"",
								// 	// 	GetType:1,
								// 	// 	basestr:JSON.stringify(base64),
								// 	// 	userIdx:that.loginMsgData.useridx,
								// 	// 	token:that.loginMsgData.webtoken,
								// 	// 	Type:1,//1-修改头像，2-背景图片
								// 	// },
								// 	success: (res) => {
								// 		console.log(res);
								// 		console.log(decrypt(res.data))
								// 	}
								// });
								
							}
						})
						// that.urlTobase64(res.tempFilePaths[0])
						
								// uni.request({
								// 	url: this.GLOBAL.urlPoint+'/userinfo/UploadHeaderImg', //仅为示例，并非真实接口地址。
								// 	method:"POST",
								// 	header: {
								// 		'content-type': 'application/x-www-form-urlencoded', //formdata 
								// 	},
								// 	data: {
								// 		picture:chooseImageRes.tempFiles[0],
								// 		userIdx:that.loginMsgData.useridx,
								// 		token:that.loginMsgData.webtoken,
								// 		Type:1,//1-修改头像，2-背景图片
								// 	},
								// 	success: (res) => {
								// 		console.log(res);
								// 		console.log(decrypt(res.data))
								// 	}
								// });
					}
				});
				// -
			},
			// ----上传视频---
			upLoadVideo:function(){
				 uni.chooseVideo({
					compressed:true,//压缩
					maxDuration:15,
					count: 1,
					sourceType: ['camera', 'album'],
					success: function (res) {
						alert(JSON.stringify(res))
					}
				});
			},
			// ---------
			// urlTobase64:function(url){
			// 	uni.request({
			// 	url: url,
			// 	method:'GET',
			// 	responseType: 'arraybuffer',
			// 	success: ress => {
			// 		let base64 = wx.arrayBufferToBase64(ress.data); //把arraybuffer转成base64 
			// 		base64 = 'data:image/jpeg;base64,' + base64 //不加上这串字符，在页面无法显示的哦
			// 		// console.log(base64)
			// 		return base64;
			// 	}
			// 	})
			// }
			//------------
		}
	}
</script>

<style lang="scss">
page{
	width: 100%;
	height: 100%;
}
.content{
	width: 100%;
	height: 100%;
	background:rgba(25,25,25,1);
	// -----nav---
	.nav{
		height: 100rpx;
		display: flex;
		justify-content: space-between;
		align-items: center;
		background:rgba(37,37,37,1);
		.img{
			height: 30rpx;
			width: 30rpx;
			padding: 10rpx;
			margin-left: 20rpx;
		}
		.title{
			font-size:30rpx;
			font-weight:400;
			color:rgba(255,255,255,1);
		}
		.save{
			font-size:30rpx;
			font-family:PingFang TC;
			font-weight:400;
			color:rgba(255,214,0,1);
			padding: 10rpx;
			margin-right: 30rpx;
		}
	}
	// ----bgArea----
	.bgArea{
		height: 370rpx;
		position: relative;
		border-bottom: 2rpx solid rgba(116,116,116,1);
		.bg{
			position: absolute;
			top:0;
			left: 0;
			width: 100%;
			height: 370rpx;
		}
		.phoArea{
			position: absolute;
			top:100rpx;
			left: 285rpx;
			width: 180rpx;
			height: 180rpx;
			.photo{
				width: 176rpx;
				height: 176rpx;
				border:2rpx solid #fff;
				border-radius: 50%;
			}
			.camera{
				position: absolute;
				top:120rpx;
				left: 120rpx;
				width: 60rpx;
				height: 60rpx;
				border-radius: 50%;
			}
		}
		.choosebg{
			position: absolute;
			bottom:28rpx;
			right: 28rpx;
			width: 60rpx;
			height: 60rpx;
			border-radius: 50%;
		}
	}
	// ---introductionArea---
	.introductionArea{
		width: 680rpx;
		padding:0 35rpx;
		.name{
			height: 85rpx;
			border-bottom:2rpx solid rgba(116,116,116,1);
			display: flex;
			align-items: center;
			.text{
				font-size:30rpx;
				color:rgba(255,255,255,1);
				margin-right:28rpx;
			}
			.input{
				font-size:30rpx;
				color:rgba(116,116,116,1);
			}
		}
		.p{
			height: 30rpx;
			margin:28rpx 0;
			display: flex;
			justify-content: space-between;
			align-items: center;
			.tltle{
				font-size:30rpx;
				color:rgba(255,255,255,1);
			}
			.num{
				font-size:22rpx;
				color:rgba(116,116,116,1);
			}
		}
		.textArea{
			background:rgba(46,46,46,1);
			border-radius:8px;
			.text{
				width: 100%;
				min-height:211rpx;
				border-radius:8px;
				color:rgba(116,116,116,1);
			}
		}
			
	}
}
</style>
